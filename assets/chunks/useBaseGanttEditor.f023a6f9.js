import{t as tn,v as Be,w as fe,p as J,x as an,g as _e,u as X,y as nn,s as je,z as rn,A as on,B as ht,C as Et,D as qe,e as pe,E as Ct,q as xt,o as ge,n as St,F as sn,_ as gt,G as ln,H as dn,I as cn,J as un,K as fn,L as Ne,M as Se,k as ye,l as se,N as W,a as xe,O as pn,P as bt,Q as mn,f as ze,R as hn,S as gn}from"../app.94690059.js";import{n as ie,b as be,A as De,c as U,a as wt,g as bn,T as re,l as wn,u as yn,B as kn,d as yt,e as vn,f as kt}from"./base-gantt.8aed563e.js";import{c as Dt,g as $e,b as Ve,a as Ee,B as Pt,d as Ge,f as Mt,h as te,j as G,p as Rt,e as Tn,z as _n,u as jn,F as En,C as Cn,S as xn,i as Sn}from"./filter-drawer.c56c4458.js";import{ay as de,a7 as $,C as p,az as ce,w as We,d as Q,h as z,f as A,O as oe,a3 as ae,k as Ot,a8 as At,B as Ke,A as Dn,F as he,a as Ze,a0 as Pe,e as Pn,V as Lt,Q as ke,Y as vt,ai as Mn}from"./framework.3b97cefe.js";import{H as Rn}from"./resource-load.e2f30ade.js";var On=Math.ceil,An=Math.max;function Ln(e,t,s,l){for(var i=-1,u=An(On((t-e)/(s||1)),0),y=Array(u);u--;)y[l?u:++i]=e,e+=s;return y}function Bn(e){return function(t,s,l){return l&&typeof l!="number"&&tn(t,s,l)&&(s=l=void 0),t=Be(t),s===void 0?(s=t,t=0):s=Be(s),l=l===void 0?t<s?1:-1:Be(l),Ln(t,s,l,e)}}var Nn=Bn();const me=Nn,Yn=[[{name:"Save",text:"保存",locale:"project.wbsEditor.save",iconName:"wbs-save",rowspan:2,iconPosition:"top",handleMethod:"save"}],[{name:"ProjectCalendar",text:"项目日历",locale:"project.wbsEditor.menu.ProjectCalendar",iconName:"wbs-project-calendar",handleMethod:"handleProjectCalendar"},{name:"ProjectTeam",text:"项目团队",locale:"project.wbsEditor.menu.ProjectTeam",iconName:"wbs-project-team",handleMethod:"openProjectTeam"},{name:"ProjectSchedule",text:"项目时间",locale:"project.wbsEditor.menu.ProjectSchedule",iconName:"wbs-project-schedule",handleMethod:"openProjectScheduleModal"},{name:"ResourceLoad",text:"资源负荷",locale:"project.wbsEditor.menu.ResourceLoad",iconName:"wbs-resource-load",handleMethod:"openResourceLoad"}],[{name:"insertTask",text:"插入任务",locale:"project.wbsEditor.menu.insertTask",iconName:"wbs-insert-task",rowspan:2,iconPosition:"top",handleMethod:"insertTask"},{name:"insertSubtask",text:"插入子任务",locale:"project.wbsEditor.menu.insertSubtask",iconName:"wbs-insert-subtask",rowspan:2,iconPosition:"top",handleMethod:"insertChildTask"},{name:"MilestoneTask",text:"里程碑任务",locale:"project.wbsEditor.menu.MilestoneTask",iconName:"wbs-milestone-task",rowspan:2,iconPosition:"top",handleMethod:"insertChildTask",handleParams:[{type:"milestone"}]}],[{name:"Upgrade",text:"任务升级",locale:"project.wbsEditor.menu.Upgrade",iconName:"wbs-upgrade",handleMethod:"taskOutdent"},{name:"demotion",text:"任务降级",locale:"project.wbsEditor.menu.demotion",iconName:"wbs-demotion",handleMethod:"taskIndent"},{name:"TaskLink",text:"任务链接",locale:"project.wbsEditor.menu.TaskLink",iconName:"wbs-task-link",handleMethod:"addRelationTaskLink"},{name:"CancelLink",text:"取消链接",locale:"project.wbsEditor.menu.CancelLink",iconName:"wbs-cancel-link",handleMethod:"deleteRelationTaskLink"},{name:"DeleteTask",text:"删除任务",locale:"project.wbsEditor.menu.DeleteTask",iconName:"wbs-delete-task",handleMethod:"deleteSelectData"},{name:"TaskAttributes",text:"任务属性",locale:"project.wbsEditor.menu.TaskAttributes",iconName:"wbs-task-attributes",handleMethod:"toEditTask"}],[{name:"View",text:"视图",locale:"project.wbsEditor.menu.View",iconName:"wbs-view",rowspan:2,iconPosition:"top",type:"dropdown",items:[{name:"ShowAll",text:"显示全部",locale:"project.wbsEditor.menu.ShowAll",iconName:"wbs-show",handleMethod:"expandAll",handleParams:[0]},{name:"collapseAll",text:"全部收起",locale:"project.wbsEditor.menu.collapseAll",handleMethod:"collapseAll",handleParams:[0],iconName:"wbs-show-all"},{name:"showLevelone",text:"显示一级",locale:"project.wbsEditor.menu.showLevelone",handleMethod:"expandAll",handleParams:[1],iconName:"wbs-show-level-one"},{name:"showLeveltwo",text:"显示二级",locale:"project.wbsEditor.menu.showLeveltwo",handleMethod:"expandAll",handleParams:[2],iconName:"wbs-show-level-two"},{name:"showLevelthree",text:"显示三级",locale:"project.wbsEditor.menu.showLevelthree",handleMethod:"expandAll",handleParams:[3],iconName:"wbs-show-level-three"}]}],[{name:"Zoom",text:"层级缩放",locale:"project.wbsEditor.menu.Zoom",iconName:"wbs-scale",rowspan:2,iconPosition:"top",type:"dropdown",items:[{name:"hourZoom",text:"小时视图",locale:"project.wbsEditor.menu.hourZoom",iconName:"wbs-scale-hour",handleMethod:"setCurrentZoom",handleParams:["hour"]},{name:"dayZoom",text:"天视图",locale:"project.wbsEditor.menu.dayZoom",iconName:"wbs-scale-day",handleMethod:"setCurrentZoom",handleParams:["day"]},{name:"weekZoom",text:"周视图",locale:"project.wbsEditor.menu.weekZoom",iconName:"wbs-scale-week",handleMethod:"setCurrentZoom",handleParams:["week"]},{name:"monthZoom",text:"月度视图",locale:"project.wbsEditor.menu.monthZoom",iconName:"wbs-scale-month",handleMethod:"setCurrentZoom",handleParams:["month"]},{name:"quarterZoom",text:"季度视图",locale:"project.wbsEditor.menu.quarterZoom",iconName:"wbs-scale-quarter",handleMethod:"setCurrentZoom",handleParams:["quarter"]},{name:"yearZoom",text:"年度视图",locale:"project.wbsEditor.menu.yearZoom",iconName:"wbs-scale-year",handleMethod:"setCurrentZoom",handleParams:["year"]}]}],[{name:"Copy",locale:"project.wbsEditor.menu.Copy",text:"复制",iconName:"wbs-copy",handleMethod:"copy"},{name:"Cut",text:"剪切",locale:"project.wbsEditor.menu.Cut",iconName:"wbs-cut",handleMethod:"cut"},{name:"Paste",text:"粘贴",locale:"project.wbsEditor.menu.Paste",iconName:"wbs-paste",handleMethod:"paste"},{name:"Undo",text:"撤销",locale:"project.wbsEditor.menu.Undo",iconName:"wbs-undo",handleMethod:"undo"},{name:"Restore",text:"恢复",locale:"project.wbsEditor.menu.Restore",iconName:"wbs-restore",handleMethod:"redo"},{name:"Search",text:"查找",locale:"project.wbsEditor.menu.Search",iconName:"wbs-search",handleMethod:"openSearch"}],[{name:"Filter",text:"筛选",locale:"project.wbsEditor.menu.Filter",iconName:"wbs-filter",handleMethod:"openFilterDrawer"},{name:"showConfig",text:"配置列",locale:"project.wbsEditor.menu.showConfig",iconName:"wbs-show-config",handleMethod:"openColumnConfigModal"}],[{name:"FreezeColumn",text:"锁定列",locale:"project.wbsEditor.menu.FreezeColumn",iconName:"wbs-freeze-column",handleMethod:"openFreezeColumns"},{name:"CancelFreezeColumn",text:"取消锁定",locale:"project.wbsEditor.menu.CancelFreezeColumn",iconName:"wbs-cancel-freeze-column",handleMethod:"cancelFreezeColumns"}],[{name:"showChart",text:"显示甘特图",locale:"project.wbsEditor.menu.showChart",handleMethod:"switchGanttGrid",handleParams:[!1],iconName:"wbs-show-chart"},{name:"hideChart",text:"关闭甘特图",locale:"project.wbsEditor.menu.hideChart",handleMethod:"switchGanttGrid",handleParams:[!0],iconName:"wbs-hide-chart"}],[{name:"showPath",text:"显示关键路径",locale:"project.wbsEditor.menu.showPath",iconName:"wbs-show-path",handleMethod:"highLightCriticalPath"},{name:"hidePath",text:"隐藏关键路径",locale:"project.wbsEditor.menu.hidePath",iconName:"wbs-show-path",handleMethod:"noLightCriticalPath"}]],Un=[{key:"0",title:"复制",locale:"project.wbsEditor.menu.Copy",icon:"wbs-copy",name:"Copy",handleMethod:"copy",rootShow:!1,fineTuning:!1,noPermission:!0},{key:"1",title:"剪切",locale:"project.wbsEditor.menu.Cut",icon:"wbs-cut",name:"Cut",handleMethod:"cut",rootShow:!1,fineTuning:!1,noPermission:!0},{key:"2",title:"粘贴",locale:"project.wbsEditor.menu.Paste",icon:"wbs-paste",name:"Paste",handleMethod:"paste",rootShow:!1,fineTuning:!1,noPermission:!0},{key:"10",name:"TaskAttributes",locale:"project.wbsEditor.menu.TaskAttributes",title:"任务属性",icon:"wbs-task-attributes",handleMethod:"toEditTask",fineTuning:!1,noPermission:!0},{key:"3",name:"InsertOtherTask",locale:"project.wbsEditor.menu.InsertOtherTask",title:"插入操作",icon:"wbs-insert-task",item:void 0,fineTuning:!1,noPermission:!0,children:[{key:"4",name:"insertSubtask",title:"插入子任务",icon:"wbs-insert-subtask",locale:"project.wbsEditor.menu.insertSubtask",handleMethod:"insertChildTask",noPermission:!0},{key:"8",name:"MilestoneTask",title:"插入里程碑任务",locale:"project.wbsEditor.menu.InsertMilestoneTask",handleMethod:"insertChildTask",icon:"wbs-milestone-task",handleParams:[{type:"milestone"}],fineTuning:!1,noPermission:!0}]},{key:"9",name:"DeleteTask",title:"删除任务",icon:"wbs-delete-task",locale:"project.wbsEditor.menu.DeleteTask",handleMethod:"deleteSelectData",rootShow:!1,fineTuning:!1,noPermission:!0},{key:"12",name:"Upgrade",title:"任务升级",icon:"wbs-upgrade",locale:"project.wbsEditor.menu.Upgrade",handleMethod:"taskOutdent",rootShow:!1,fineTuning:!1,noPermission:!0},{key:"13",name:"demotion",title:"任务降级",icon:"wbs-demotion",locale:"project.wbsEditor.menu.demotion",handleMethod:"taskIndent",rootShow:!1,fineTuning:!1,noPermission:!0},{key:"14",name:"UpdateResource",title:"更新资源",locale:"project.wbsEditor.menu.updateResource",icon:"wbs-project-team",handleMethod:"openUpdateResource",noPermission:!0},{key:"15",name:"About",title:"关于",icon:"wbs-more",locale:"project.wbsEditor.menu.About",handleMethod:"about",noPermission:!0}],In=e=>fe.confirm({class:"wbs-confirm-modal",closable:!1,...e,onCancel(){var s;(s=e.onCancel)==null||s.call(e)},onOk(){var s;(s=e.onOk)==null||s.call(e)}}),Bt=e=>{const t=fe.confirm({class:"wbs-confirm-modal",title:"删除确认",content:"确定要删除该对象吗？删除后⽆法找回。",okText:"确定",okType:"primary",cancelText:"取消",width:448,centered:!0,closable:!0,onCancel(){t.destroy()},...e});return t},Z={asap:"project.wbsEditor.asap",alap:"project.wbsEditor.alap",mso:"project.wbsEditor.mso",mfo:"project.wbsEditor.mfo",snet:"project.wbsEditor.snet",fnet:"project.wbsEditor.fnet",snlt:"project.wbsEditor.snlt",fnlt:"project.wbsEditor.fnlt"},Fn=[{key:"asap",label:Z.asap},{key:"alap",label:Z.alap},{key:"mso",label:Z.mso},{key:"mfo",label:Z.mfo},{key:"snet",label:Z.snet},{key:"fnet",label:Z.fnet},{key:"snlt",label:Z.snlt},{key:"fnlt",label:Z.fnlt}],Hn=[{key:"asap",label:Z.asap},{key:"snet",label:Z.snet},{key:"fnlt",label:Z.fnlt}],Ye=[{id:"0",text:"project.wbsEditor.task.predecessor.finishToStart"},{id:"1",text:"project.wbsEditor.task.predecessor.startToStart"},{id:"2",text:"project.wbsEditor.task.predecessor.finishToFinish"},{id:"3",text:"project.wbsEditor.task.predecessor.startToFinish"}],Ue="localEditUniqueKey",qn=["auto_scheduling","text","resource","remarks"],zn=["duration","start_date","end_date"],$n=["checkbox","progress"],Vn={checkbox:de(()=>ce(()=>import("./inline-checkbox.e06c36c6.js"),["assets/chunks/inline-checkbox.e06c36c6.js","assets/chunks/framework.3b97cefe.js","assets/app.94690059.js","assets/chunks/theme.e4c10142.js"])),progress:de(()=>ce(()=>import("./inline-progress.14035637.js"),["assets/chunks/inline-progress.14035637.js","assets/chunks/framework.3b97cefe.js","assets/app.94690059.js","assets/chunks/theme.e4c10142.js"])),select:de(()=>ce(()=>import("./inline-select.474444c5.js"),["assets/chunks/inline-select.474444c5.js","assets/chunks/framework.3b97cefe.js","assets/app.94690059.js","assets/chunks/theme.e4c10142.js"])),workDatePicker:de(()=>ce(()=>import("./inline-work-datepicker.83527897.js"),["assets/chunks/inline-work-datepicker.83527897.js","assets/app.94690059.js","assets/chunks/framework.3b97cefe.js","assets/chunks/theme.e4c10142.js","assets/chunks/base-gantt.8aed563e.js","assets/chunks/filter-drawer.c56c4458.js","assets/chunks/resource-load.e2f30ade.js"])),durationInput:de(()=>ce(()=>import("./inline-duration-input.1aec0deb.js"),["assets/chunks/inline-duration-input.1aec0deb.js","assets/chunks/framework.3b97cefe.js","assets/app.94690059.js","assets/chunks/theme.e4c10142.js"])),resource:de(()=>ce(()=>import("./inline-resource.22e882d4.js"),["assets/chunks/inline-resource.22e882d4.js","assets/chunks/framework.3b97cefe.js","assets/app.94690059.js","assets/chunks/theme.e4c10142.js"])),textInput:de(()=>ce(()=>import("./inline-input.b951b44f.js"),["assets/chunks/inline-input.b951b44f.js","assets/chunks/framework.3b97cefe.js","assets/app.94690059.js","assets/chunks/theme.e4c10142.js"])),status:de(()=>ce(()=>import("./inline-status.e0cf6674.js"),["assets/chunks/inline-status.e0cf6674.js","assets/chunks/base-gantt.8aed563e.js","assets/app.94690059.js","assets/chunks/framework.3b97cefe.js","assets/chunks/theme.e4c10142.js"]))},Gn={select:{style:"padding-left: 4px; overflow: hidden; text-overflow: ellipsis;"},workDatePicker:{style:"padding-right: 10px"},resource:{style:"overflow: hidden; text-overflow: ellipsis;"},textInput:{style:"padding-left: 5px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"}},Wn=e=>{var l;const t=e.textFormatter?e.textFormatter(e.data,e.name,e):e.data[e.name];if((e==null?void 0:e.from)==="base")return t;let s=!1;return(l=e==null?void 0:e.columns)==null||l.forEach(i=>{var u,y,_,g;if(i.name.indexOf(e.name)>-1){let k=1;switch(e.data.type==="project"&&(k=3),e.name){case"resource":if(t&&typeof t=="string"){const T=((u=t==null?void 0:t.split(";"))==null?void 0:u.length)-1;((t==null?void 0:t.length)-T)*(9+k)+T*(3+k)>i.width&&(s=!0)}break;case"text":if(e!=null&&e.node&&((_=(y=e==null?void 0:e.node)==null?void 0:y.getElementsByClassName("gantt-inline-edit"))!=null&&_.length)){const T=((g=e==null?void 0:e.node)==null?void 0:g.getElementsByClassName("gantt-inline-edit")[0]).offsetWidth??0;typeof t=="string"&&(t!=null&&t.length)&&t.length*(7.5+k)>i.width-T&&(s=!0)}break;default:typeof t=="string"&&(t!=null&&t.length)&&t.length*(7.5+k)>i.width&&(s=!0);break}}}),s?t:void 0},Kn={select:(e,t,s)=>{var l,i,u;if(((l=s==null?void 0:s.editorProps)==null?void 0:l.mode)==="multiple"){let y="";return e[t]&&e[t].length>0&&((i=e[t])==null||i.forEach((_,g)=>{var k;y+=(k=s.editorProps.options.find(T=>T.value===_))==null?void 0:k.label,g!==e[t].length-1&&(y+=";")})),y}return(u=s.editorProps.options.find(y=>y.value===e[t]))==null?void 0:u.label},workDatePicker:(e,t,s)=>e[t]?J(e[t]).format(s.editorProps.timeType==="time"?"YYYY-MM-DD HH:mm":"YYYY-MM-DD"):""},Zn=(e,t)=>(t.forEach(s=>{e.forEach(l=>{var i;s.name===l.name&&(s._from="built",((i=l==null?void 0:l.targetAttribute)==null?void 0:i.length)>0&&l.targetAttribute.forEach(u=>{s[u]=l[u]}))})}),t),Jn=(e,t)=>(e.filter(l=>l._from!=="built").forEach(l=>{l._from="base",l.editorProps=l.editorProps||{};const i=l.type;i&&(i==="input"?l.editor={type:"text",map_to:l.name}:l.onrender=u=>{var y,_;return ue(i,{data:u,selectedIds:t.selectedIds,name:l.name,from:l._from,editorProps:{instance:t.currentGanttInstance,options:l.options||((_=(y=t==null?void 0:t.optionsMap)==null?void 0:y.value)==null?void 0:_[l.name])||[],onUpdateValue:Dt(t.currentGanttInstance),userLang:t.userLang,timeType:t.timeType,...l.editorProps},textFormatter:Kn[i]})})}),e),ve=(e,t)=>p(Vn[e],t),ue=(e,t)=>$({render(){var _,g,k,T;const l=t.textProps||{},i=t.selectedIds,u=((_=i==null?void 0:i.value)==null?void 0:_.length)===1&&((g=i==null?void 0:i.value)==null?void 0:g[0])===((T=(k=t.data.id)==null?void 0:k.toString)==null?void 0:T.call(k));return $("div",{class:"gantt-inline-edit"},(()=>{if($n.includes(e))return ve(e,{...t.editorProps,data:t.data,name:t.name});{let f=!0;t.data.isRoot?f=t.data.type==="project"?qn.includes(t.name):!0:f=t.data.type==="project"?!zn.includes(t.name):!0,(t==null?void 0:t.from)==="base"&&(f=!0),t.data.readonly&&(f=!1);let a=!0;!t.data[ie]&&be.includes(t.data.task_status)&&(a=!1);let b=!0;return t.data[De.AUTH_RESOLVE_FLAG]&&(b=!1),u&&f&&a&&b?ve(e,{...t.editorProps,data:t.data,name:t.name}):$("div",{...Gn[e],...l,title:Wn(t)},t.textFormatter?t.textFormatter(t.data,t.name,t):t.data[t.name])}})())}}),Qn=(e,t,s,l,i)=>{const u=i==null?void 0:i.t;let y=t.ext.formatters.durationFormatter({store:"minute",format:"day",hoursPerDay:s.hoursPerDay}),_=t.ext.formatters.durationFormatter({store:"day",format:"minute",hoursPerDay:s.hoursPerDay}),g=t.ext.formatters.durationFormatter(s),k=t.ext.formatters.linkFormatter({durationFormatter:g});We(()=>s,()=>{g=t.ext.formatters.durationFormatter(s),k=t.ext.formatters.linkFormatter({durationFormatter:g}),y=t.ext.formatters.durationFormatter({store:"minute",format:"day",hoursPerDay:s.hoursPerDay}),_=t.ext.formatters.durationFormatter({store:"day",format:"minute",hoursPerDay:s.hoursPerDay})},{deep:!0}),t.config.editor_types.progress={show:(h,r,n,c)=>{if(t.getTask(h).type==t.config.types.task){const E="<div><input type='text' name='"+r.name+"'></div>";c.innerHTML=E}},set_value:function(h,r,n,c){t.getTask(r).type==t.config.types.task&&(c.querySelector("input").value=h*100+"%")},get_value:(h,r,n)=>{var P,M,F;const c=(P=n.querySelector("input"))==null?void 0:P.value.indexOf("%");let d=0;const E=((M=n.querySelector("input"))==null?void 0:M.value.substring(0,c))||((F=n.querySelector("input"))==null?void 0:F.value);return E&&(d=Number(E)/100),d},is_changed:function(h,r,n,c){const d=this.get_value(r,n,c);return h!==d},is_valid:(h,r,n,c)=>{var M,F,N;const d=(M=c.querySelector("input"))==null?void 0:M.value.indexOf("%"),E=Number(((F=c.querySelector("input"))==null?void 0:F.value.substring(0,d))||((N=c.querySelector("input"))==null?void 0:N.value));return E>=0&&E<=100},focus:h=>{const r=h.querySelector("input");r&&(r.focus&&r.focus(),r.select&&r.select())}},t.config.editor_types.text={show:(h,r,n,c)=>{let d=60,E=u("project.wbsEditor.inputTaskName");r.name==="remarks"&&(d=256,E=u("project.wbsEditor.task.inputTaskRemark"));const P=`<div id='inlineInputText'><input type='text' placeholder='${E}' 
      maxlength='${d}' name='${r.name}'></div>`;c.innerHTML=P},get_value:(h,r,n)=>{var d;return(d=n.querySelector("input"))==null?void 0:d.value},set_value:(h,r,n,c)=>{c.querySelector("input").value=h||""},is_changed:function(h,r,n,c){const d=this.get_value(r,n,c);return h!==d},is_valid:(h,r,n,c)=>{var P;return((P=c.querySelector("input"))==null?void 0:P.value).length>0},focus:h=>{const r=h.querySelector("input");r&&(r.focus&&r.focus(),r.select&&r.select())}};const T=(h,r)=>{const n=document.createElement("div");n.className="label_width";const c=document.createElement("span");h==null||h.forEach(M=>{M.name.indexOf(r)>-1&&(c.innerText=M.label,M.label_back=M.label)});const d=document.createElement("span");d.className="label_collapse_all_icon",d.title=u("project.wbsEditor.menu.ShowAll");const E=document.createElement("span");E.className="label_collapse_one_icon",E.title=u("project.wbsEditor.menu.showLevelone"),n.appendChild(d),n.appendChild(E),n.appendChild(c);const P=document.body;return P.onclick=M=>{var F,N,C,D,m,w;((C=(N=(F=M.target)==null?void 0:F.className)==null?void 0:N.indexOf)==null?void 0:C.call(N,"label_collapse_all_icon"))>-1&&(i==null||i.baseGanttMethods.expandBaseGanttLevel(0)),((w=(m=(D=M.target)==null?void 0:D.className)==null?void 0:m.indexOf)==null?void 0:w.call(m,"label_collapse_one_icon"))>-1&&(i==null||i.baseGanttMethods.collapseBaseGanttLevel(1))},n.outerHTML},f={text:{type:"text",map_to:"text"},predecessors:{type:"predecessor",map_to:"auto",get formatter(){return k}},progress:{type:"progress",map_to:"progress"},successors:{type:"successor",map_to:"auto"},durationEditor:{type:"duration",map_to:"duration",get formatter(){return g}},constraint_type:{type:"select",map_to:"constraint_type",options:[{key:"asap",label:t.locale.labels.asap},{key:"alap",label:t.locale.labels.alap},{key:"snet",label:t.locale.labels.snet},{key:"snlt",label:t.locale.labels.snlt},{key:"fnet",label:t.locale.labels.fnet},{key:"fnlt",label:t.locale.labels.fnlt},{key:"mso",label:t.locale.labels.mso},{key:"mfo",label:t.locale.labels.mfo}]},start_date:{type:"date",map_to:"start_date"},end_date:{type:"date",map_to:"end_date"},remarks:{type:"text",map_to:"remarks"}},a=Dt(t),b=[{name:"wbs",targetAttribute:["template"],template:t.getWBSCode},{name:"auto_scheduling",targetAttribute:["onrender"],onrender:h=>ue("select",{selectedIds:i.selectedIds,data:h,name:"auto_scheduling",columns:e,textProps:{style:"padding-right: 18px"},editorProps:{onUpdateValue:a,options:[{value:1,realValue:!0,label:u("project.wbsEditor.task.AutoMode")},{value:0,realValue:!1,label:u("project.wbsEditor.task.manualMode")}],showSearch:!1},textFormatter:r=>r.auto_scheduling?u("project.wbsEditor.task.AutoMode"):u("project.wbsEditor.task.manualMode")})},{name:"text",targetAttribute:["label","onrender"],label:T(e,"text"),editor:f.text,onrender:(h,r)=>{var c;const n="active-search-cell";return h.id===(i==null?void 0:i.activeSearchCell.taskId)?r.classList.add(n):r.classList.remove(n),(c=r==null?void 0:r.getElementsByClassName("gantt_tree_content"))!=null&&c.length&&(r.getElementsByClassName("gantt_tree_content")[0].innerHTML=""),ue("textInput",{selectedIds:i.selectedIds,data:h,node:r,name:"text",columns:e,editorProps:{onUpdateValue(d,E,P){if(!P)return;const M=t.getTask(d);M[E]=P,t.updateTask(d)},maxlength:60},textFormatter:d=>d.text})}},{name:"progress",targetAttribute:["onrender"],template:h=>Math.floor(h.progress*100)+"%",editor:f.progress,onrender:(h,r)=>ve("progress",{selectedIds:i.selectedIds,data:h,node:r,onUpdateValue:a,name:"progress",instance:t,t:i.t,editorProps:i.props})},{name:"duration",targetAttribute:["onrender"],template:h=>g.format(h.duration)?g.format(h.duration):"--",editor:f.durationEditor,onrender:h=>ue("durationInput",{selectedIds:i.selectedIds,data:h,name:"duration",columns:e,editorProps:{instance:t,durationUnit:i.tempDurationUnit,get minuteformatter(){return y},get dayformatter(){return _},onUpdateValue(r,n,c){const d=t.getTask(r);d.duration=c;let E=!0;l.forEach(P=>{P.calendarId===d.calendar_id&&P.calendar&&(d.end_date=P.calendar.calculateEndDate({start_date:d.start_date,duration:d.duration,task:d}),E=!1)}),E&&(d.end_date=t.calculateEndDate({start_date:d.start_date,duration:d.duration,task:d})),t.updateTask(r)}},textFormatter:r=>g.format(r.duration)?g.format(r.duration):"--"})},{name:"start_date",targetAttribute:["onrender"],editor:f.start_date,onrender:h=>ue("workDatePicker",{selectedIds:i.selectedIds,data:h,name:"start_date",columns:e,editorProps:{instance:t,userLang:i.userLang,timeType:i.tempDurationUnit==="minute"?"time":"start",onUpdateValue(r,n,c){const d=t.getTask(r);d.start_date=c,d.constraint_type="snet",d.constraint_date=c;let E=!0;l.forEach(P=>{P.calendarId===d.calendar_id&&P.calendar&&(d.end_date=P.calendar.calculateEndDate({start_date:d.start_date,duration:d.duration,task:d}),E=!1)}),E&&(d.end_date=t.calculateEndDate({start_date:d.start_date,duration:d.duration,task:d})),setTimeout(()=>{t.updateTask(r)})}},textFormatter:r=>J(r.start_date).format(i.tempDurationUnit==="day"?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")})},{name:"end_date",targetAttribute:["onrender"],editor:f.end_date,onrender:(h,r)=>ue("workDatePicker",{selectedIds:i.selectedIds,data:h,name:"end_date",columns:e,editorProps:{instance:t,node:r,userLang:i.userLang,timeType:i.tempDurationUnit==="minute"?"time":"end",onUpdateValue(n,c,d){const E=t.getTask(n);if(d.getTime()<E.start_date.getTime()){U(u("project.wbsEditor.task.timeSelectTip"));return}const P=t.getCalendar(E.calendar_id);let M=0;if(P?M=P==null?void 0:P.calculateDuration({start_date:E.start_date,end_date:d}):M=t==null?void 0:t.calculateDuration({start_date:E.start_date,end_date:d}),M/60/s.hoursPerDay>3650){U(u("project.wbsEditor.task.durationCannotExceed"));return}E.end_date=d,setTimeout(()=>{t.updateTask(n)})}},textFormatter:n=>J(n.end_date).format(i.tempDurationUnit==="day"?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")})},{name:"predecessors",targetAttribute:["template","editor"],template:h=>{const r=h.$target,n=[];for(let c=0;c<r.length;c++){const d=t.getLink(r[c]);d&&n.push(k.format(d))}return n.length>0?n.join(", "):"--"},editor:f.predecessors},{name:"constraint_date",targetAttribute:["template"],template:h=>h.constraint_date?J(h.constraint_date).format(i.tempDurationUnit==="day"?"YYYY-MM-DD":"YYYY-MM-DD HH:mm"):"--"},{name:"plan_hour",targetAttribute:["template"],template:h=>parseFloat((h.duration/60).toFixed(2))},{name:"constraint_type",targetAttribute:["template"],template:h=>Z[h.constraint_type]?u(Z[h.constraint_type]):"--"},{name:"task_status",targetAttribute:["onrender"],template:h=>wt[h.task_status]?u(wt[h.task_status]):"--",onrender:(h,r)=>ve("status",{data:h,node:r,name:"task_status",t:i.t})},{name:"review_point",targetAttribute:["onrender"],onrender:(h,r)=>(h.review_point===void 0&&(h.review_point=!1),ve("checkbox",{data:h,node:r,onUpdateValue:a,name:"review_point",disabled:!!t.hasChild(h.id)||h.isRoot}))},{name:"task_resource",targetAttribute:["onrender"],onrender:h=>ue("resource",{selectedIds:i.selectedIds,data:h,name:"resource",columns:e,editorProps:{instance:t,onUpdateValue(r,n,c){var N;const d=t.getTask(r);if((c==null?void 0:c.length)===0){d[n]=[],d.project_role_id="",d.project_role="",d.task_resource="",t.updateTask(r,d);return}let E="";const P=[],M=[],F=(N=d[n])==null?void 0:N.find(C=>C.isMainResource&&C.resourceType==="HR"&&c.includes(C.resource));if(F)E=F.resource;else for(let C=0;C<c.length;C++)if(i.baseConfig.resourceOptions.findIndex(m=>m.type_id==="HR"&&c[C]===m.id)!==-1){E=c[C];break}c.forEach(C=>{i.baseConfig.resourceOptions.forEach(D=>{var m;if(D.id===C){const w=(m=d[n])==null?void 0:m.find(x=>x.resource===C);P.push({resource:C,proportion:w!=null&&w.proportion?w==null?void 0:w.proportion:100,isMainResource:D.id===E,resourceType:D.type_id}),D.type_id==="HR"&&M.push(D.role)}})}),an(d[n],P)||(d[n]=P,M!=null&&M.includes(d.project_role_id)&&new Set(M).size!==1&&(d.project_role_id="",d.project_role=""),d.task_resource=$e(P,i.baseConfig.resourceOptions),t.updateTask(r,d))},options:i.baseConfig.resourceGroupOptions},textFormatter:r=>{var n;return(n=i.baseConfig.resourceOptions)!=null&&n.length?$e(r.resource,i.baseConfig.resourceOptions):r.task_resource}})},{name:"remarks",targetAttribute:["onrender"],editor:f.remarks,onrender:h=>ue("textInput",{selectedIds:i.selectedIds,data:h,name:"remarks",columns:e,editorProps:{onUpdateValue:a,maxlength:256},textFormatter:r=>r.remarks})}];return Zn(b,e)},Xn=e=>!0,Nt=(e,t,s={})=>{const l=[];return e.forEach(i=>{Yt(l,i,t,s)}),l},Yt=(e,t,s,l={})=>{var _,g,k;const i=(_=s==null?void 0:s.names)==null?void 0:_.indexOf(t.name),u=s==null?void 0:s.buttons[i];if(i===-1&&!(t!=null&&t.noPermission))return;let y=!1;if(l.excludes&&(y=l.excludes.includes(t.name)),i>-1&&Xn(u==null?void 0:u.key)&&!y||t!=null&&t.noPermission){const T=((g=l.custom)==null?void 0:g.find(a=>a.name===t.name))||{},f=t!=null&&t.noPermission?{...t,...T}:{...u,...t,...T};if(f.disabled=((k=l.disables)==null?void 0:k.includes(t.name))||t.disabled,e.push(f),t.items){const a=t.items;f.items=[],a.forEach(b=>{let h=!1;l.excludes&&(h=l.excludes.includes(b.name)),!h&&Yt(f.items,b,s,l)})}else f.items=[]}},er={initialLoad:{type:Boolean,default:!0},calendarsApi:{type:Object,required:!0,default:()=>({})},configApi:{type:Object,required:!0,default:()=>({})},dataSourceApi:{type:Object,required:!0,default:()=>({})},menusApi:{type:Object,default:()=>({})},menusArray:{type:Array,default:()=>[]},resourcesApi:{type:Object,default:()=>({})},queryLoadApi:{type:Object,default:()=>({})},resourcesData:{type:Object,default:()=>({})},saveDataApi:{type:Object,default:()=>({})},saveColumnsApi:{type:Object,default:()=>({})},durationUnit:{type:String,default:"minute",required:!0},projectId:{type:String,required:!0,default:""},planId:{type:String},fineTuning:{type:Boolean,default:!1},bizType:{type:String,default:"1"},enableGanttMenus:{type:Boolean,default:!1},menuConfig:{type:Object,default:()=>({excludes:[],disabled:[]})},contextMenuConfig:{type:Object,default:()=>({excludes:[]})},editorMode:{type:String,default:""},checkProjectStart:{type:Boolean,default:!1},checkMileStoneUpdate:{type:Boolean,default:!1},separateProjectStart:{type:Boolean,default:!0},refreshAfterSave:{type:Boolean,default:!1},dragProgress:{type:Boolean,default:!0},progressCalculate:{type:Boolean,default:!0},scheduleProjectConstraint:{type:Boolean,default:!0},showStartEndDateLine:{type:Boolean,default:!0},showProjectEndMarker:{type:Boolean,default:!1},showFullScreen:{type:Boolean,default:!1}},tr=(e,t,s,l,i,u)=>{let y={add:{data:[],links:[]},update:{data:[],links:[]}};const _=(T,f)=>{var b;let a=0;if(Object.values(T.data).forEach(h=>{a+=Object.values(h).flat().length}),!a)return f?U(u("project.wbsEditor.noDataSaveTip"),"info"):t.closeBaseGanttLoading(),!1;if(l.checkProjectStart){const h=e.getTask(e.getChildren(e.config.root_id)[0]).start_date;if(new Date(h).getTime()<new Date(e.config.project_start).getTime()){const r=e.config.project_start;return U(u("project.wbs.checkProjectStart",{text:J(r).format(l.durationUnit==="minute"?"YYYY-MM-DD HH:mm":"YYYY-MM-DD")})),!1}}if(l.checkMileStoneUpdate){let h=!0;if((b=T.data.update.data)==null||b.forEach(r=>{r.type==="milestone"&&(s==null||s.forEach(n=>{n.id===r.id&&new Date(n.start_date).getTime()!==new Date(r.start_date).getTime()&&(U(u("project.wbs.checkMileStoneUpdate",{text:r.text,start:J(n.start_date).format(l.durationUnit==="minute"?"YYYY-MM-DD HH:mm":"YYYY-MM-DD")})),h=!1)}))}),!h)return!1}return!0},g=(T=!0)=>{var a;const f=t.getDifferenceData();if(!_(f,T))return{};if(Object.keys(l.saveDataApi).length===0)return i("saveBaseGanttData",f),f;T&&t.enableBaseGanttLoading(u("project.wbsEditor.dataInSaving")),(a=l==null?void 0:l.saveDataApi)!=null&&a.params&&Object.assign(l.saveDataApi.params,{...l.saveDataApi.params,projectId:l.projectId,fineTuning:l.fineTuning,bizType:l.bizType,...f}),_e({...l.saveDataApi}).then(b=>{b.code===200?k(f):(U(b.msg),t.closeBaseGanttLoading())}).catch(()=>{t.closeBaseGanttLoading()})},k=T=>{var f,a,b,h;U(u("project.wbsEditor.saveSuccess"),"success"),t.closeBaseGanttLoading(),l.refreshAfterSave?t.queryBaseGanttData({},!1,u("project.wbsEditor.dataInSaving")):(y={add:{data:[],links:[]},update:{data:[],links:[]}},(f=T.data.add.data)==null||f.forEach(r=>{r[ie]&&y.add.data.push(r.id)}),(a=T.data.add.links)==null||a.forEach(r=>{r[ie]&&y.add.links.push(r.id)}),(b=T.data.update.data)==null||b.forEach(r=>{y.update.data.push(r.id)}),(h=T.data.update.links)==null||h.forEach(r=>{y.update.links.push(r.id)}),t.updateBaseGanttData(y))};return{beforeSaveBaseGanttData:_,saveDifferenceBaseGanttData:g,afterSaveBaseGanttData:k}},ar=(e,t,s,l)=>{const i=(k,T=!1)=>{let f=!0;const a=t.checkTaskLimit(k,T);return a!==""&&(U(a),f=!1),f};return{checkCommonTaskRules:i,checkTaskCanOperate:k=>i(k,!0),checkTaskCanAddChild:k=>{let T=!0;return k[De.AUTH_RESOLVE_FLAG]&&k.isRoot?!0:(k==null?void 0:k.type)==="milestone"?(U(l("project.wbs.canNotAddChildTask")),!1):((k.readonly||!k[ie]&&be.includes(k.task_status))&&(be.includes(k.task_status)?U(l("project.wbs.canNotEdit")):U(l("project.wbs.readOnlyTaskStatusTip",{text:k.text})),T=!1),T)},checkCanOperateLinks:()=>{var f,a;let k=!0;const T=(f=e==null?void 0:e.value)==null?void 0:f.getSelectedTasks();for(let b=1;b<T.length;b++){const h=(a=e==null?void 0:e.value)==null?void 0:a.getTask(T[b]);if(k=i(h),k===!1)break}return k},checkSelectedTaskCanOperate:(k=!0)=>{var a,b,h;let T=!0;const f=(a=e==null?void 0:e.value)==null?void 0:a.getSelectedTasks();for(let r=0;r<f.length;r++){const n=(b=e==null?void 0:e.value)==null?void 0:b.getTask(f[r]);if(T=i(n,!0),T===!1)break;if(k){const c=[];t.getChildTaskId(n.id,c);for(let d=0;d<c.length;d++){const E=c[d],P=(h=e==null?void 0:e.value)==null?void 0:h.getTask(E);if(T=i(P),T===!1)return T}}}return T}}},nr=(e,t,s,l,i)=>{const u=["wbs-project-calendar-modal","wbs-task-addUpdate-modal","wbs-column-config-modal","wbs-project-team-modal","wbs-project-date-modal","wbs-update-resource-modal","wbs-search-modal"],y=()=>{var k,T;let g=!0;return u.forEach(f=>{var a;((a=document.getElementsByClassName(f))==null?void 0:a.length)!==0&&(g=!1)}),((k=s.value)!=null&&k.visible||(T=l.value)!=null&&T.visible)&&(g=!1),document.getElementById("inlineInputText")&&(g=!1),g};return{handleKeyDown:g=>{var k,T,f,a,b,h,r,n,c,d,E,P,M,F,N;if(y()){if(g.ctrlKey&&[67,68,70,71,72,76,83,85,86,88,89,90].includes(g.keyCode)&&(g.preventDefault(),g.stopPropagation()),g.ctrlKey&&g.keyCode===67&&((k=e==null?void 0:e.copy)==null||k.call(e)),g.ctrlKey&&g.keyCode===68&&((T=document.getElementsByClassName("wbs-delete-modal"))==null?void 0:T.length)===0&&((f=e==null?void 0:e.deleteSelectData)==null||f.call(e)),g.ctrlKey&&g.keyCode===70&&((a=e==null?void 0:e.openSearch)==null||a.call(e)),g.ctrlKey&&g.keyCode===71&&((b=e==null?void 0:e.openFilterDrawer)==null||b.call(e)),g.ctrlKey&&g.keyCode===72&&((h=e==null?void 0:e.switchGanttGrid)==null||h.call(e,!0)),g.ctrlKey&&g.keyCode===76&&((r=e==null?void 0:e.switchGanttGrid)==null||r.call(e,!1)),g.ctrlKey&&g.keyCode===83){if((n=t.value)!=null&&n.spinning)return U(i("project.wbsEditor.saving"));(c=e==null?void 0:e.saveDifferenceBaseGanttData)==null||c.call(e)}g.ctrlKey&&g.keyCode===85&&((d=document.getElementsByClassName("wbs-update-resource-modal"))==null?void 0:d.length)===0&&((E=e==null?void 0:e.openUpdateResource)==null||E.call(e)),g.ctrlKey&&g.keyCode===86&&((P=e==null?void 0:e.paste)==null||P.call(e)),g.ctrlKey&&g.keyCode===88&&((M=e==null?void 0:e.cut)==null||M.call(e)),g.ctrlKey&&g.keyCode===89&&((F=e==null?void 0:e.redo)==null||F.call(e)),g.ctrlKey&&g.keyCode===90&&((N=e==null?void 0:e.undo)==null||N.call(e))}}}},rr=(e,t,s,l,i)=>{const u=f=>{e.resource=f,e.resourceOptions=[f.DR,f.HR,f.MR].filter(b=>b).flat().filter((b,h,r)=>r.findIndex(n=>n.id===b.id)===h);const a=["HR","DR","MR"];e.resourceGroupOptions=[],a.forEach(b=>{f[b]&&f[b].length>0&&e.resourceGroupOptions.push({name:i(b==="HR"?"project.wbsEditor.HR":b==="DR"?"project.wbsEditor.DR":"project.wbsEditor.MR"),options:f[b]})})};return{updateResourceOptions:()=>{var f;Object.keys(l.resourcesApi).length!==0?((f=l==null?void 0:l.resourcesApi)!=null&&f.params&&Object.assign(l.resourcesApi.params,{...l.resourcesApi.params,projectId:l.projectId}),_e({...l.resourcesApi}).then(a=>{a.code===200&&u(a.data)})):Object.keys(l.resourcesData).length!==0&&u(l.resourcesData)},batchUpdateResource:f=>{var a;(a=t.value)==null||a.batchUpdate(()=>{var b;(b=t.value)==null||b.eachSelectedTask(h=>{var c,d;const r=(c=t.value)==null?void 0:c.getTask(h);if(!s.checkTaskLimit(r)){r.resource=[];let E=!1;f.forEach(P=>{e.resourceOptions.forEach(M=>{var F;if(M.id===P){const N={resource:P,proportion:100,resourceType:M.type_id};M.resourceType==="HR"&&!E?(E=!0,N.isMainResource=!0):N.isMainResource=!1,(F=r.resource)==null||F.push(N)}})}),(d=t.value)==null||d.updateTask(r.id,r)}})})},checkCanRemoveResource:f=>{var r;let a=!0;const b=[],h=new Set;return(r=t.value)==null||r.eachTask(n=>{n.resource&&n.resource.forEach(c=>{c.resource&&h.add(c.resource)})}),f&&(f==null?void 0:f.length)>0&&(f==null||f.forEach(n=>{h.has(n)&&(a=!1,b.push(n))})),{canRemoveFlag:a,canNotRemoveIds:b}},addResourceData:f=>{f&&f.length>0&&(f==null||f.forEach(a=>{var b;typeof a.type_id=="string"&&a.type_id!==""&&(e.resource[a.type_id]&&((b=e.resource[a.type_id])==null?void 0:b.length)>0?e.resource[a.type_id].findIndex(r=>r.id===a.id)===-1&&e.resource[a.type_id].push(a):e.resource[a.type_id]=[a])}),u(e.resource))},removeResourceData:f=>{f&&f.length>0&&(f==null||f.forEach(a=>{var b;if(typeof a.type_id=="string"&&a.type_id!==""&&e.resource[a.type_id]&&((b=e.resource[a.type_id])==null?void 0:b.length)>0){const h=e.resource[a.type_id].findIndex(r=>r.id===a.id);h!==-1&&e.resource[a.type_id].splice(h,1)}}),u(e.resource))}}},Tt=Q({name:"CustomTextButton",props:{iconPosition:{type:String,default:"left"},items:{type:Array,require:!1,default:()=>[]},disabled:{type:Boolean,default:!1},handleMethod:{type:String,default:""},handleParams:{type:Array,default:()=>[]}},emits:["methodsHandler"],setup(e,{slots:t,emit:s}){const{t:l}=X(),i=z(()=>e.items&&e.items.length),u=(a,b)=>()=>s("methodsHandler",a,b),y=a=>$("span",{style:"padding-right: 8px; font-size: 18px"},$(je,{name:a,size:15})),_=$(je,{name:"wbs-drop-down",class:"custom-text-button-dropdown-icon"}),g=z(()=>t.icon?$("span",{class:"custom-text-button-icon-container"},[$("span",{class:"custom-text-button-icon"},[$(t.icon)]),i.value&&e.iconPosition==="top"?_:""]):null),k=$("span",{class:e.iconPosition!=="top"?"custom-text-button-content-container":"custom-text-button-content-container-custom"},[$(t.default),i.value&&e.iconPosition!=="top"?_:""]),T=z(()=>["custom-text-button","ant-btn ant-btn-text",...Object.entries({"flex-column-center":()=>e.iconPosition==="top"}).filter(h=>h[1]())]),f=()=>$("button",{class:T.value,disabled:e.disabled,onClick:u(e.handleMethod,e.handleParams)},[g.value,k]);return()=>i.value?$(nn,{onClick:u(e.handleMethod,e.handleParams)},{default:f,overlay:()=>$(rn,{},{default:()=>e.items.map(a=>a.items&&a.items.length>0?$(on,{},{title:()=>[a.iconName?y(a.iconName):"",a.locale?l(a.locale):a.text],default:()=>a.items.map(b=>$(ht,{onClick:u(b.handleMethod,b.handleParams),disabled:b.disabled},{default:()=>[b.iconName?y(b.iconName):"",b.locale?l(b.locale):b.text]}))}):$(ht,{onClick:u(a.handleMethod,a.handleParams),disabled:a.disabled},{default:()=>[a.iconName?y(a.iconName):"",a.locale?l(a.locale):a.text]}))})}):f()}}),or=Q({name:"BaseGanttMenus",props:{handleMethods:{type:Object},allButtons:{type:Object},excludes:{type:Array,default:()=>[]},disables:{type:Array,default:()=>[]},ganttId:{type:String,default:""},independent:{type:Array},custom:{type:Array}},setup(e){const{t}=X(),s=A(),l=oe(Ve,A("zh-CN")),i=A(),u=z(()=>{const f=[];return(e.independent||Yn).forEach(b=>{f.push(Nt(b,e.allButtons,{excludes:e.excludes,disables:e.disables,custom:e.custom}))}),f}),y=z(()=>t("project.wbsEditor.more")),_=ae({name:"More",text:y,iconName:"wbs-more",rowspan:2,iconPosition:"top",type:"dropdown",items:[]}),g=Et(()=>{var r,n,c;const f=s.value,a=f.getBoundingClientRect().width-parseInt(getComputedStyle(f).paddingLeft)-parseInt(getComputedStyle(f).paddingRight),b=Array.from(f.children);_.items=[];let h=((c=(n=(r=b[b.length-1])==null?void 0:r.getBoundingClientRect)==null?void 0:n.call(r))==null?void 0:c.width)||0;for(let d=0;d<b.length-1;d++)if(h+=b[d].getBoundingClientRect().width,h>a){b[d].style.position="fixed",b[d].style.left="-9999px";const E=JSON.parse(JSON.stringify(u.value[d]));E.length===1&&E[0].name==="More"&&!_.items.length?_.items=[...E[0].items]:_.items=[..._.items,...E]}else{b[d].removeAttribute("style");const E=JSON.parse(JSON.stringify(u.value[d]));E.length===1&&E[0].name==="More"&&(b[d].style.position="fixed",b[d].style.left="-9999px",_.items=[...E[0].items])}},200),k=f=>{const a={};return f.rowspan&&typeof f.rowspan=="number"&&(a.gridRowEnd="span "+f.rowspan),f.colspan&&typeof f.colspan=="number"&&(a.gridColumnEnd="span "+f.colspan),a},T=(f,a)=>{let b=f;typeof b=="string"&&(b=e.handleMethods[f]),b&&typeof b=="function"&&(a?b(...a):b())};return We(()=>l.value,()=>{g()}),Ot(()=>{g(),i.value=new ResizeObserver(()=>{g()}),i.value.observe(s.value)}),At(()=>{i.value.disconnect()}),()=>p("div",{class:"base-gantt-menus-container",ref:s},[u.value.length>0&&u.value.map((f,a)=>p("div",{key:a},[f.length>0&&p("div",{class:"base-gantt-menus-group"},[f.map(b=>p("div",{style:k(b)},[p(Tt,Ke({onMethodsHandler:T},b),{default:()=>b.locale?t(b.locale):b.text,icon:()=>p(je,{name:b.iconName,size:15},null)})]))])])),p("div",{class:"base-gantt-menus-group",style:_.items.length>0?"":"position:fixed; left:-9999px;"},[p("div",{style:k(_)},[p(Tt,{"icon-position":_.iconPosition,items:_.items,onMethodsHandler:T},{default:()=>_.locale?t(_.locale):_.text,icon:()=>p(je,{name:_.iconName},null)})])])])}}),Ut=e=>{var h;const t=(e==null?void 0:e.instance)||((h=oe(Ee))==null?void 0:h.value);let s={};const l=window.localStorage.getItem("separateProjectStart")==="true";e&&(s=e);const i=r=>r&&(J.isDayjs(r)?r.toDate():new Date(r)),u=()=>l?J(t.config.project_start):J(t.getTask(t.getChildren(t.config.root_id)[0]).start_date),y=()=>t.getTaskCalendar(t.getTask(t.getChildren(t.config.root_id)[0])),_=(r,n)=>{const c=e.calendar?e.calendar:y();return c!=null&&c.getClosestWorkTime?c.getClosestWorkTime({date:i(r),dir:(n==null?void 0:n.dir)||"future"}):r},g=r=>{const n=e.calendar?e.calendar:y();return n!=null&&n.isWorkTime?!n.isWorkTime({date:i(r),unit:"day"}):!1},k=r=>{let n=!1;const c=u();return s.needDisableBeforeProejctStart()&&(n=J(c).set("millisecond",0).set("second",0).set("minute",0).set("hour",0).toDate()>i(r)),n||g(r)},T=(r,n,c)=>{c=c.split(":");const d=n[c[0]],E=d==null?void 0:d[r];E?E.push(c[1]):d?d[r]=[c[1]]:n[c[0]]={[r]:[c[1]]}},f=r=>{var n,c;return(((n=r==null?void 0:r.end)==null?void 0:n.length)||0)>=(((c=r==null?void 0:r.start)==null?void 0:c.length)||0)},a=()=>{const r=u(),n=r.hour(),c=r.minute();return{hour:n,minute:c,hours:me(0,24).filter(d=>d<n),minutes:me(0,60).filter(d=>d<c),projectStart:r}};return{getProjectStart:u,getClosestWorkTime:_,checkIsNotWorkTime:g,disableDate:k,disbledTime:r=>{var C,D,m,w;if(!t||!r)return;r=J(r);let n=e.calendar?e.calendar.getWorkHours(i(r)):y().getWorkHours(i(r));if(typeof n[0]=="number"){const x=[];for(let R=0;R<n.length;R+=2){const[L,q]=[n[R],n[R+1]];L&&q&&x.push(`${L}:00-${q}:00`)}n=x}const c={0:{end:[0]},24:{start:[60]}};n.forEach(x=>{const[R,L]=x.split("-");T("start",c,R),T("end",c,L)});const d=c[r.hour()];let E=me(0,60),P=me(0,24);const M=Object.keys(c).map(x=>Number(x)).sort((x,R)=>x-R);if(M.forEach((x,R)=>{const L=M[R-1]||0;x-L>1&&f(c[L])&&!f(c[x])&&(P=P.filter(S=>{var I,Y,K,ne;return S<L||S===L&&((I=c[S])==null?void 0:I.end[0])!==0||S>x||S===x&&!(((K=(Y=c[x])==null?void 0:Y.end)==null?void 0:K.length)===1&&((ne=c[x])==null?void 0:ne.end[0])===0)}))}),d){const x=((C=d.start)==null?void 0:C.length)||0,R=((D=d.end)==null?void 0:D.length)||0,L=Math.max(x,R);for(let q=0;q<L;q++){const S=((m=d.start)==null?void 0:m[q])||0,I=((w=d.end)==null?void 0:w[q])||60;E=E.filter(Y=>Y<S||Y>I)}}else E.length=0;const F=a(),N=F.projectStart.valueOf()>r.valueOf()-r.valueOf()%(1e3*60*60*24);return{disabledHours:()=>s.needDisableBeforeProejctStart()&&N?me(0,24).filter(x=>!P.includes(x)||x<F.hour):me(0,24).filter(x=>!P.includes(x)),disabledMinutes:()=>s.needDisableBeforeProejctStart()&&N&&F.projectStart.hour()===r.hour()?[...new Set([...E,...F.minutes])]:E}}}};var le=(e=>(e.humanResource="HR",e.deviceResource="DR",e.materialResource="MR",e.projectRoles="roles",e))(le||{});function Ie(e){return typeof e=="function"||Object.prototype.toString.call(e)==="[object Object]"&&!Pe(e)}const sr=Q({name:"TaskResources",props:{originTask:Object,disabled:{type:Boolean,default:!1}},setup(e,{expose:t}){const{t:s}=X(),l=[{field:"resourceType",required:!0},{field:"resource",required:!0},{field:"proportion",required:!0,validate:m=>/^([1-9][0-9]{0,1}|100)$/.test(m.proportion)?Promise.resolve({state:"ok"}):Promise.reject({state:"fail",msg:s("project.wbsEditor.taskResource.resourceRatioTip")})},{field:"isMainResource",required:!0}],i=[];let u=0;const y=A((e.originTask.resource||[]).map(m=>({...m,_id:u++}))),_=z(()=>y.value.map(m=>m.resource)),g=A(),k=A(-1),T=A({value:e.originTask.project_role_id,label:e.originTask.project_role}),f=ae({}),a=(m,w)=>typeof w.options=="function"?w.options({record:m,column:w}):w.options||[],b=(m,w,x)=>{var R;return(R=a(m,w).find(L=>L.id===x))==null?void 0:R.name},h=z(()=>{var m;return(m=T.value)!=null&&m.value?i.filter(w=>w.id===le.humanResource):i}),r=z(()=>[{title:s("project.wbsEditor.taskResource.index"),dataIndex:"index",valueType:"index",width:60},{title:s("project.wbsEditor.taskResource.resourceType"),dataIndex:"resourceType",editable:{onChange({record:m},w){w===le.humanResource?y.value.findIndex(R=>R.isMainResource)<0&&(m.isMainResource=!0):m.isMainResource=!1,m.resource=void 0}},valueType:"Select",options:h},{title:s("project.wbsEditor.resourceName"),dataIndex:"resource",valueType:"Select",editable:!0,options:({record:m})=>f[m.resourceType].filter((w,x,R)=>{var L,q;return!((L=T.value)!=null&&L.value)&&R.findIndex(S=>S.id===w.id)===x||w.role===((q=T.value)==null?void 0:q.value)}).map(w=>({...w,disabled:_.value.includes(w.id)}))||[],width:240},{title:s("project.wbsEditor.OccupancyRatio"),dataIndex:"proportion",valueType:"Input",editable:!0},{title:s("project.wbsEditor.taskResource.isMainResource"),dataIndex:"isMainResource",valueType:"Select",editable:{onChange({record:m},w){w&&y.value.forEach(x=>{x._id!==m._id&&x.isMainResource&&(x.isMainResource=!1)})},readonly:({record:m})=>y.value.length===1&&m.resourceType===le.humanResource?!0:m.resourceType!==le.humanResource},options:[{name:s("project.wbsEditor.yes"),id:!0},{name:s("project.wbsEditor.no"),id:!1}]},{title:s("project.wbsEditor.operation"),dataIndex:"operation",valueType:"action",align:"center",width:80}]),n=m=>{if(E.includes(m._id))return"fail-row"},c=oe(Ge);(()=>{const m=c==null?void 0:c.resource,w=Object.keys(m).filter(x=>{var R;return m[x]&&((R=m[x])==null?void 0:R.length)>0});w==null||w.forEach(x=>{f[x]=m[x],x!==le.projectRoles&&i.push({id:x,name:s(`project.wbsEditor.${x}`)})})})();const E=ae([]),P=async m=>{E.length=0;const w=Promise.resolve();for(let x=0;x<m.length;x++){const R=m[x];for(let L=0;L<l.length;L++){const q=l[L];if(q.required&&[void 0,null,""].includes(R[q.field]))return E.push(R._id),Promise.reject({state:"fail",type:"required",msg:s("project.wbsEditor.taskResource.ResourceTip")});if(q.validate)try{await q.validate(R)}catch(S){return E.push(R._id),Promise.reject(S)}}}return w},M=()=>{setTimeout(()=>{k.value=-1;const m=g.value.getSelectedKeys();if((m==null?void 0:m.length)===0){U(s("project.wbsEditor.task.batchDeleteTip"));return}y.value=y.value.filter(w=>!m.includes(w._id)),y.value.length===1&&y.value[0].resourceType===le.humanResource&&(y.value[0].isMainResource=!0)})},F=(m,w,x)=>{e.disabled||k.value!==x&&(k.value>=0?P([y.value[k.value]]).then(()=>{k.value=x}).catch(R=>{U(R.msg)}):k.value=x)},N=()=>{P(y.value).then(()=>{let m=!1;y.value.findIndex(x=>x.isMainResource)<0&&(m=!0),y.value=[...y.value,{_id:u++,resourceType:h.value[0].id,proportion:"100",isMainResource:m}],k.value=y.value.length-1}).catch(m=>{U(m.msg)})},C=async(m=!0)=>{var w,x;if(m)try{await P(y.value)}catch(R){return U(R.msg),!1}return{resource:y.value,project_role:(w=T.value)==null?void 0:w.label,project_role_id:(x=T.value)==null?void 0:x.value}},D=(m,w)=>{var x;return((x=w==null?void 0:w.name)==null?void 0:x.indexOf(m))>-1};return t({getResource:C}),()=>p("div",{class:"wbs-task-resource"},[p(Pt,null,{default:()=>{let m;return p("div",{class:"wbs-task-resource-title"},[p("span",{class:"table-title"},[s("project.wbsEditor.taskResource.resourceList")]),p(Dn("bable"),{class:"table-title-tip"},Ie(m=s("project.wbsEditor.onlyMainResourceTip"))?m:{default:()=>[m]})])},titleRight:()=>{let m;return p(qe,null,{default:()=>[p(pe,{onClick:M,disabled:e.disabled},Ie(m=s("project.wbsEditor.delete"))?m:{default:()=>[m]})]})}}),p(Ct,{id:"wbsTaskResourceTable",ref:g,class:"wbs-task-resource-table",rowKey:"_id",animateRows:!1,pagination:!1,toolbar:!1,showTitleTip:!1,dataSource:y.value,columns:r.value,scroll:{y:260},"row-selection":{type:"checkbox",memory:!0,clickSelectTrigger:"row",unSelectable:!0},rowClassName:n,onRowClick:F},{bodyCell:({index:m,column:w,text:x,record:R})=>{var q;let L;return p(he,null,[p(qe,null,{default:()=>[w.valueType==="action"&&p(pe,{type:"link",onClick:M},Ie(L=s("project.wbsEditor.delete"))?L:{default:()=>[L]})]}),k.value!==m||!w.useEditable||(q=w.useEditable)!=null&&q.readonly&&w.useEditable.readonly({index:m,column:w,text:x,record:R},x)?p("span",null,[w.valueType==="Select"?b(R,w,x):x]):p(he,null,[w.valueType.toLowerCase()==="input"&&p(xt,{value:R[w.dataIndex],"onUpdate:value":S=>R[w.dataIndex]=S},null),w.valueType.toLowerCase()==="select"&&p(ge,{value:R[w.dataIndex],"onUpdate:value":S=>R[w.dataIndex]=S,dropdownClassName:"task-resouce-select-input",class:"full-width","show-search":!0,"filter-option":D,fieldNames:{label:"name",value:"id"},optionLabelProp:"name",options:a(R,w),onChange:S=>{var I;(I=w.useEditable)!=null&&I.onChange&&w.useEditable.onChange({index:m,column:w,text:x,record:R},S)},placeholder:s("project.wbsEditor.resource.selectResource")},null),w.valueType.toLowerCase()!=="select"&&w.valueType.toLowerCase()!=="input"&&p("span",null,[w])])])},footer:()=>p(he,null,[!e.disabled&&p(pe,{type:"dashed",block:!0,onClick:N},{default:()=>[Ze("+ "),s("project.wbsEditor.increase")]})])})])}});function Fe(e){return typeof e=="function"||Object.prototype.toString.call(e)==="[object Object]"&&!Pe(e)}const lr=Q({name:"TaskPredecessor",props:{originTask:Object,dayformatter:Object},setup(e,{expose:t}){var N;const{t:s}=X();Ye.forEach(C=>{C.text=s(C.text)});const l=oe(Ee).value,i=oe(Mt);let u=Ye;const y=A(),_=A(-1),g=A([]),k=z(()=>{const C=[];l.eachParent(m=>{C.push(m.id)},e.originTask.id),C.push(e.originTask.id);const D=[];return l.eachTask(m=>{C.includes(m.id)||D.push({id:m.id,type:m.type,text:m.text})}),D});(((N=e.originTask)==null?void 0:N.type)==="project"||e.originTask[De.AUTH_RESOLVE])&&(u=Ye.filter(C=>C.id==="0"||C.id==="1"));const T=[{field:"source",required:!0},{field:"type",required:!0}],f=z(()=>[{title:s("project.wbsEditor.taskResource.index"),dataIndex:"index",valueType:"index",width:85},{title:s("project.wbsEditor.task.predecessor.taskName"),dataIndex:"source",valueType:"select",editable:!0,width:300,options:()=>k.value.map(C=>({...C,disabled:g.value.filter(D=>D.source===C.id).length>0}))},{title:s("project.wbsEditor.task.predecessor.constraintType"),dataIndex:"type",valueType:"select",editable:!0,options:u,width:160},{title:s("project.wbsEditor.task.predecessor.lag"),dataIndex:"lag",valueType:"inputNumber",editable:!0,width:140},{title:s("project.wbsEditor.operation"),dataIndex:"operation",valueType:"action",align:"center",width:85}]);(()=>{const C=e.originTask.$target;Object.prototype.toString.call(C)==="[object Array]"&&C.forEach(D=>{const m=l.getLink(D);if(m){const w=JSON.parse(JSON.stringify(m));(w==null?void 0:w.lag)!==void 0&&(w.lag=parseFloat(e.dayformatter.format(w.lag))),g.value.push(w)}})})();const b=(C,D)=>{var m;return((m=D==null?void 0:D.label)==null?void 0:m.indexOf(C))>-1},h=(C,D)=>typeof D.options=="function"?D.options({record:C,column:D}):D.options||[],r=(C,D,m)=>{var w;return(w=h(C,D).find(x=>x.id===m))==null?void 0:w.text},n=C=>{if(c.includes(C.id))return"fail-row"},c=ae([]),d=async C=>{c.length=0;const D=Promise.resolve();for(let m=0;m<C.length;m++){const w=C[m];for(let x=0;x<T.length;x++){const R=T[x];if(R.required&&[void 0,null,""].includes(w[R.field]))return c.push(w.id),Promise.reject({state:"fail",type:"required",msg:s("project.wbsEditor.taskPredecessor.requireTip")});if(R.validate)try{await R.validate(w)}catch(L){return c.push(w.id),Promise.reject(L)}}}return D},E=(C,D,m)=>{_.value!==m&&(_.value>=0?d(g.value).then(()=>{_.value=m}).catch(w=>{g.value.forEach((x,R)=>{c.includes(x.id)&&(_.value=R)}),U(w.msg)}):_.value=m)},P=()=>{d(g.value).then(()=>{const C={id:bn(i),source:void 0,type:"0",lag:0};C[ie]=!0,g.value=[...g.value,C],_.value=g.value.length-1}).catch(C=>{U(C.msg)})},M=()=>{_.value=-1,setTimeout(()=>{const C=y.value.getSelectedKeys();if((C==null?void 0:C.length)===0){U(s("project.wbsEditor.task.batchDeleteTip"));return}g.value=g.value.filter(D=>!C.includes(D.id))})};return t({getPredecessor:()=>{const C={delete:[],add:[],update:[]},D=g.value.map(m=>({...m})).filter(m=>m.source!==void 0);return Object.prototype.toString.call(e.originTask.$target)==="[object Array]"&&(C.delete=e.originTask.$target.filter(m=>!D.find(w=>w.id===m))),C.update=D.filter(m=>e.originTask.$target.includes(m.id)&&!C.delete.includes(m.id)),C.add=D.filter(m=>m[ie]&&!C.update.find(w=>m.id===w.id)&&!C.delete.includes(m.id)).map(m=>(m.target=e.originTask.id,m)),C}}),()=>p("div",{class:"wbs-task-predecessor"},[p(Pt,null,{default:()=>p("div",{class:"wbs-task-predecessor-title"},[p("span",{class:"table-title"},[s("project.wbsEditor.predecessor.predecessorList")])]),titleRight:()=>{let C;return p(pe,{onClick:M},Fe(C=s("project.wbsEditor.delete"))?C:{default:()=>[C]})}}),p(Ct,{id:"wbsTaskPredecessorTable",ref:y,class:"wbs-task-predecessor-table",rowKey:"id",animateRows:!1,pagination:!1,toolbar:!1,showTitleTip:!1,dataSource:g.value,columns:f.value,scroll:{y:260},"row-selection":{type:"checkbox",memory:!0,clickSelectTrigger:"row",unSelectable:!0},rowClassName:n,onRowClick:E},{bodyCell:({index:C,column:D,text:m,record:w})=>{let x,R;return p(he,null,[_.value!==C||!D.useEditable?p("span",null,[D.valueType==="select"?r(w,D,m):m]):p(he,null,[D.dataIndex==="lag"&&p(St,{value:w[D.dataIndex],"onUpdate:value":L=>w[D.dataIndex]=L},null),D.dataIndex==="source"&&p(ge,{class:"full-width","show-search":!0,"filter-option":b,value:w[D.dataIndex],"onUpdate:value":L=>w[D.dataIndex]=L,optionLabelProp:"label",placeholder:s("project.wbsEditor.task.selectPredecessor")},Fe(x=h(w,D).map(L=>p(sn,{key:L.id,value:L.id,label:L.text,disabled:L.disabled},{default:()=>[p("div",{class:L.type+"-icon",style:{opacity:L.disabled?"0.3":"1"}},[p("span",null,[L.text])])]})))?x:{default:()=>[x]}),D.dataIndex==="type"&&p(ge,{class:"full-width",value:w[D.dataIndex],"onUpdate:value":L=>w[D.dataIndex]=L,fieldNames:{label:"text",value:"id"},options:h(w,D),optionLabelProp:"text"},null)]),p(qe,null,{default:()=>[D.valueType==="action"&&p(pe,{type:"link",onClick:M},Fe(R=s("project.wbsEditor.delete"))?R:{default:()=>[R]})]})])},footer:()=>p(pe,{type:"dashed",block:!0,onClick:P},{default:()=>[Ze("+ "),s("project.wbsEditor.increase")]})})])}});var ir={locale:"zh_CN",today:"今天",now:"此刻",backToToday:"返回今天",ok:"确定",timeSelect:"选择时间",dateSelect:"选择日期",weekSelect:"选择周",clear:"清除",month:"月",year:"年",previousMonth:"上个月 (翻页上键)",nextMonth:"下个月 (翻页下键)",monthSelect:"选择月份",yearSelect:"选择年份",decadeSelect:"选择年代",yearFormat:"YYYY年",dayFormat:"D日",dateFormat:"YYYY年M月D日",dateTimeFormat:"YYYY年M月D日 HH时mm分ss秒",previousYear:"上一年 (Control键加左方向键)",nextYear:"下一年 (Control键加右方向键)",previousDecade:"上一年代",nextDecade:"下一年代",previousCentury:"上一世纪",nextCentury:"下一世纪"};const dr=ir;var cr={placeholder:"请选择时间",rangePlaceholder:["开始时间","结束时间"]};const ur=cr;var It={lang:gt({placeholder:"请选择日期",yearPlaceholder:"请选择年份",quarterPlaceholder:"请选择季度",monthPlaceholder:"请选择月份",weekPlaceholder:"请选择周",rangePlaceholder:["开始日期","结束日期"],rangeYearPlaceholder:["开始年份","结束年份"],rangeMonthPlaceholder:["开始月份","结束月份"],rangeQuarterPlaceholder:["开始季度","结束季度"],rangeWeekPlaceholder:["开始周","结束周"]},dr),timePickerLocale:gt({},ur)};It.lang.ok="确定";const fr=It;var pr={exports:{}};(function(e,t){(function(s,l){e.exports=l(ln)})(dn,function(s){function l(y){return y&&typeof y=="object"&&"default"in y?y:{default:y}}var i=l(s),u={name:"zh-cn",weekdays:"星期日_星期一_星期二_星期三_星期四_星期五_星期六".split("_"),weekdaysShort:"周日_周一_周二_周三_周四_周五_周六".split("_"),weekdaysMin:"日_一_二_三_四_五_六".split("_"),months:"一月_二月_三月_四月_五月_六月_七月_八月_九月_十月_十一月_十二月".split("_"),monthsShort:"1月_2月_3月_4月_5月_6月_7月_8月_9月_10月_11月_12月".split("_"),ordinal:function(y,_){return _==="W"?y+"周":y+"日"},weekStart:1,yearStart:4,formats:{LT:"HH:mm",LTS:"HH:mm:ss",L:"YYYY/MM/DD",LL:"YYYY年M月D日",LLL:"YYYY年M月D日Ah点mm分",LLLL:"YYYY年M月D日ddddAh点mm分",l:"YYYY/M/D",ll:"YYYY年M月D日",lll:"YYYY年M月D日 HH:mm",llll:"YYYY年M月D日dddd HH:mm"},relativeTime:{future:"%s内",past:"%s前",s:"几秒",m:"1 分钟",mm:"%d 分钟",h:"1 小时",hh:"%d 小时",d:"1 天",dd:"%d 天",M:"1 个月",MM:"%d 个月",y:"1 年",yy:"%d 年"},meridiem:function(y,_){var g=100*y+_;return g<600?"凌晨":g<900?"早上":g<1100?"上午":g<1300?"中午":g<1800?"下午":"晚上"}};return i.default.locale(u,null,!0),u})})(pr);const Ce=Q({name:"WorkTimePicker",props:{modelValue:{type:Object},needDisableBeforeProejctStart:Boolean,calendar:{type:Object},timeType:{type:String,default:"time"},instance:{type:Object},userLang:{type:String,default:"zhs"}},emits:["update:modelValue","change"],setup(e,{emit:t,attrs:s,expose:l}){const i=Pn(e.userLang||oe(Ve)),u=z(()=>["zhs","zh_CN","zh-CN"].includes(i+"")?fr:un),y=a=>{switch(e.timeType){case"start":return T(a.startOf("day"),{dir:"future"});case"end":return T(a.endOf("day"),{dir:"past"});case"day":return a.startOf("day").toDate();default:return T(a,{dir:"past"})}},_=a=>{const b=te(y(a));t("update:modelValue",te(b)),t("change",te(b))},{disbledTime:g,checkIsNotWorkTime:k,getClosestWorkTime:T,disableDate:f}=Ut({needDisableBeforeProejctStart:()=>e.needDisableBeforeProejctStart,calendar:e.calendar,instance:e.instance});return l({checkIsNotWorkTime:k}),()=>p(cn,Ke({class:"wbs-work-date-picker"},s,{value:e.modelValue,"onUpdate:value":_,allowClear:!1,format:e.timeType==="time"?"YYYY-MM-DD HH:mm":"YYYY-MM-DD","show-time":e.timeType==="time","show-now":!1,disabledTime:g,disabledDate:f,locale:u.value}),null)}});function _t(e){return typeof e=="function"||Object.prototype.toString.call(e)==="[object Object]"&&!Pe(e)}const mr=Q({name:"AddOrUpdateTask",props:{originTask:Object,fineTuning:Boolean,action:String,durationUnit:String,durationFormatterObj:Object,scheduleProjectConstraint:Boolean},emits:[],setup(e,{expose:t}){const{t:s}=X(),l=A(),i=A(!1),u=A(),y=z(()=>e.originTask.type==="project"),_=z(()=>!!e.originTask.isRoot),g=A("base"),{getProjectStart:k}=Ut(),T=A(),f=z(()=>!!(e.fineTuning&&(e.originTask.type==="milestone"||!e.originTask[ie]&&be.includes(e.originTask.task_status)))),a=oe(Ee).value,b=z(()=>{let S=a.getCalendar(e.originTask.calendar_id);return S||(S=a.getCalendar("global")),S}),h=a.ext.formatters.durationFormatter({enter:"day",store:"minute",format:"day",hoursPerDay:e.durationFormatterObj.hoursPerDay}),r=z(()=>{const S=a.hasChild(e.originTask.id),I=e.originTask.is_resolve;let Y=[];return S||I?Y=Hn:Y=Fn,Y.map(K=>({...K,label:s(K.label)}))}),n=ae({id:"",text:"",start_date:void 0,end_date:void 0,duration:0,duration_day:0,constraint_type:void 0,constraint_date:void 0,task_resource:void 0,is_milestone:void 0,remarks:"",auto_scheduling:!0,task_status:re.TASKNEW}),c={snet:"start_date",snlt:"start_date",fnet:"end_date",fnlt:"end_date",mso:"start_date",mfo:"end_date"},d=S=>{T.value.clearValidate("constraint_date");const I=c[S];n.constraint_date=n[I]},E=z(()=>["asap","alap"].includes(n.constraint_type)),P=z(()=>({text:[{required:!0,trigger:"change",message:s("project.wbsEditor.inputTaskName")},{max:60,message:s("project.wbsEditor.task.nameLengthTip")}],start_date:[{required:!0,message:s("project.wbsEditor.task.selectStartTime")}],end_date:[{required:!0,message:s("project.wbsEditor.task.selectEndTime")},{validator:async(S,I)=>{if(G(I)-G(n.start_date)<0)return Promise.reject(s("project.wbsEditor.task.timeSelectTip"));if(n.duration_day>3650)return Promise.reject(s("project.wbsEditor.task.durationCannotExceed"))},trigger:"change"}],duration:[{required:!0,message:s("project.wbsEditor.task.inputDuration")}],constraint_type:[{required:n.auto_scheduling,message:s("project.wbsEditor.task.selectConstraintType")}],constraint_date:[{validator:async(S,I)=>{if(["mfo","fnlt","fnet"].includes(n.constraint_type)&&b.value.calculateDuration({start_date:G(k()),end_date:G(I),task:e.originTask})<n.duration)return Promise.reject(s("project.wbsEditor.task.constraintDatevalidateFail"))},trigger:"change"}]})),M=S=>parseFloat(h.format(S)),F=()=>{const S=e.originTask;return{...S,start_date:S.start_date&&te(S.start_date),end_date:S.end_date&&te(S.end_date),constraint_date:S.auto_scheduling?S.constraint_date&&te(S.constraint_date):void 0,is_milestone:S.type==="milestone"}};(()=>{var I;const S=F();e.action==="Add"&&S.start_date&&(S.end_date=S.end_date&&te(b.value.calculateEndDate({start_date:G(S.start_date),duration:e.durationFormatterObj.hoursPerDay*60,task:e.originTask}))),Object.keys(n).forEach(Y=>{Object.prototype.hasOwnProperty.call(S,Y)&&(n[Y]=S[Y])}),n.duration=b.value.calculateDuration({start_date:G(S.start_date),end_date:G(S.end_date),task:e.originTask}),n.duration_day=M(n.duration),(I=e.originTask)!=null&&I.isRoot&&(i.value=!0)})();const C={asap:{start:()=>{n.constraint_type="snet",d(n.constraint_type)}},mso:{},mfo:{constraint:()=>{},end:()=>{}},snet:{constraint:()=>{},start:()=>{n.constraint_date=n.start_date}},fnet:{constraint:()=>{}}},D=S=>{var I,Y;n.end_date=te(b.value.calculateEndDate({start_date:G(S),duration:n.duration,task:e.originTask})),(Y=(I=C[n.constraint_type])==null?void 0:I.start)==null||Y.call(I)},m=S=>{var K,ne;const I=G(S),Y=G(n.start_date);I-Y>=0&&(n.duration=b.value.calculateDuration({start_date:Y,end_date:I,task:e.originTask}),n.duration_day=M(n.duration)),(ne=(K=C[n.constraint_type])==null?void 0:K.end)==null||ne.call(K)},w=S=>{n.duration=h.parse(S.toString()),n.end_date=te(b.value.calculateEndDate({start_date:G(n.start_date),duration:n.duration,task:e.originTask})),m(n.end_date)},x=()=>{var S,I;(I=(S=C[n.constraint_type])==null?void 0:S.constraint)==null||I.call(S)},R=()=>T.value.validate().then(()=>n),L=async()=>{var S;if(l.value)return await((S=l==null?void 0:l.value)==null?void 0:S.getPredecessor())},q=async()=>{var S,I;if(u.value)return await((S=u==null?void 0:u.value)==null?void 0:S.getResource());if(e.fineTuning)return{resource:(I=e.originTask)==null?void 0:I.resource,project_role:e.originTask.project_role,project_role_id:e.originTask.project_role_id}};return We(()=>n.auto_scheduling,()=>{n.auto_scheduling?n.constraint_type="asap":(n.constraint_type=void 0,n.constraint_date=void 0)}),t({validate:R,getTaskPredecessor:L,getTaskResource:q}),()=>{let S,I;return p("div",{class:"add-or-update-task-content"},[p(fn,{activeKey:g.value,"onUpdate:activeKey":Y=>g.value=Y},{default:()=>[p(Ne,{key:"base",tab:s("project.wbsEditor.task.baseInfo")},{default:()=>[p(Se,{ref:T,rules:P.value,model:n,"label-col":{span:7,style:{width:"130px"}},"wrapper-col":{span:17},colon:!1,style:{"margin-left":"-45px"}},{default:()=>[p(ye,null,{default:()=>[p(se,{span:12},{default:()=>[p(W,{label:s("project.wbsEditor.taskName"),name:"text"},{default:()=>[p(xt,{value:n.text,"onUpdate:value":Y=>n.text=Y,placeholder:s("project.wbsEditor.inputTaskName"),disabled:f.value,maxlength:60,showCount:!0,autocomplete:"off"},null)]})]}),p(se,{span:12},{default:()=>[p(W,{label:s("project.wbs.duration"),name:"duration_day"},{default:()=>[p(St,{value:n.duration_day,"onUpdate:value":Y=>n.duration_day=Y,placeholder:s("project.wbsEditor.inputDuration"),min:0,max:3650,precision:e.durationUnit==="day"?0:void 0,"addon-after":s("project.wbs.day"),class:"full-width",disabled:_.value||y.value||f.value,onChange:w},null)]})]})]}),p(ye,null,{default:()=>[p(se,{span:12},{default:()=>[p(W,{label:s("project.wbs.projectStartDate"),name:"start_date"},{default:()=>[p(Ce,{class:"full-width",value:n.start_date,"onUpdate:value":Y=>n.start_date=Y,"time-type":e.durationUnit==="day"?"start":"time",placeholder:s("project.wbsEditor.task.selectStartTime"),disabled:_.value||y.value||f.value,needDisableBeforeProejctStart:!0,calendar:b.value,onChange:D},null)]})]}),p(se,{span:12},{default:()=>[p(W,{label:s("project.wbs.projectEndDate"),name:"end_date"},{default:()=>[p(Ce,{class:"full-width",value:n.end_date,"onUpdate:value":Y=>n.end_date=Y,"time-type":e.durationUnit==="day"?"end":"time",placeholder:s("project.wbsEditor.task.selectEndTime"),disabled:_.value||y.value||f.value,needDisableBeforeProejctStart:!0,calendar:b.value,onChange:m},null)]})]})]}),p(ye,null,{default:()=>[p(se,{span:12},{default:()=>[p(W,{label:s("project.wbsEditor.task.constraintType"),name:"constraint_type"},{default:()=>[p(ge,{class:"full-width",value:n.constraint_type,"onUpdate:value":Y=>n.constraint_type=Y,options:r,optionLabelProp:"label","field-names":{label:"label",value:"key"},disabled:_.value||!e.scheduleProjectConstraint&&y.value||n.auto_scheduling===!1||f.value,onChange:d},null)]})]}),p(se,{span:12},{default:()=>[p(W,{label:s("project.wbsEditor.task.constraintDate"),name:"constraint_date"},{default:()=>[p(Ce,{class:"full-width","time-type":e.durationUnit==="day"?["mfo","fnlt","fnet"].includes(n.constraint_type)?"end":"start":"time",value:n.constraint_date,"onUpdate:value":Y=>n.constraint_date=Y,placeholder:s("project.wbsEditor.task.selectConstraintDate"),needDisableBeforeProejctStart:!0,calendar:b.value,disabled:_.value||E.value||n.auto_scheduling===!1||f.value,onChange:x},null)]})]})]}),p(ye,null,{default:()=>[p(se,{span:9,offset:3,style:{"padding-left":"20px"}},{default:()=>[p(W,{label:"",name:"is_milestone"},{default:()=>[p(xe,{checked:n.is_milestone,"onUpdate:checked":Y=>n.is_milestone=Y,disabled:e.fineTuning||_.value||y.value||f.value},_t(S=s("project.wbsEditor.isMilestone"))?S:{default:()=>[S]})]})]}),p(se,{span:12},{default:()=>[p(W,{label:s("project.wbsEditor.task.taskMode"),name:"auto_scheduling"},{default:()=>[p(pn,{value:n.auto_scheduling,"onUpdate:value":Y=>n.auto_scheduling=Y,class:"task-mode-radio-group",disabled:f.value},{default:()=>[p(bt,{value:!0},{default:()=>[Ze(" "),s("project.wbsEditor.task.AutoMode")]}),p(bt,{value:!1},_t(I=s("project.wbsEditor.task.manualMode"))?I:{default:()=>[I]})]})]})]})]}),p(ye,null,{default:()=>[p(se,{span:24,style:{padding:"0 2px 0 19px"}},{default:()=>[p(W,{label:s("project.wbsEditor.task.taskRemark"),name:"remarks","label-col":{span:3},"wrapper-col":{span:21}},{default:()=>[p(mn,{value:n.remarks,"onUpdate:value":Y=>n.remarks=Y,placeholder:s("project.wbsEditor.task.inputTaskRemark"),rows:4,maxlength:256,showCount:!0,disabled:f.value,autocomplete:"off"},null)]})]})]})]})]}),p(Ne,{key:"predecessors",disabled:i.value,tab:s("project.wbsEditor.task.predecessor")},{default:()=>[p(lr,{ref:l,originTask:e.originTask,dayformatter:h},null)]}),p(Ne,{key:"resource",tab:s("project.wbsEditor.task.taskResource")},{default:()=>[p(sr,{ref:u,originTask:e.originTask,disabled:f.value},null)]})]})])}}}),hr=Q({name:"AddOrUpdateTaskModal",props:{fineTuning:Boolean,durationUnit:String,durationFormatterObj:Object,scheduleProjectConstraint:Boolean},emits:["cancelAddTask","sureAddOrUpdate"],setup(e,{emit:t,expose:s}){const{t:l}=X(),i=ae({action:"Add",id:"",origin:{}}),u=A(!1),y=oe(Ee),_=A(),g=oe(Ge),k=n=>{var c,d;if(i.action=n.$new?"Add":"Update",n.$new){const E=(c=y.value)==null?void 0:c.getTask(n.parent);if(E&&((d=E==null?void 0:E.resource)==null?void 0:d.length)>0){const P=ze(E.resource);P.forEach(M=>{M.taskId=n.id}),n.resource=P}}i.id=n.id,i.origin=n,u.value=!0},T=n=>{let c;return n.is_milestone?c="milestone":c=i.origin.type==="milestone"?"task":i.origin.type,{...i.origin,text:n.text,duration:n.duration,start_date:G(n.start_date),end_date:G(n.end_date),constraint_type:n.constraint_type,constraint_date:G(n.constraint_date),type:c,remarks:n.remarks,auto_scheduling:n.auto_scheduling,task_status:n.task_status}},f=async()=>{var c;return await((c=_==null?void 0:_.value)==null?void 0:c.getTaskPredecessor())},a=(n=[],c)=>{for(let d=0;d<n.length;d++){const E=y.value.getTask(n[d].source);if(y.value.isCircularLink(n[d]))return U(l("project.wbsEditor.circular",{text:E.text}),"warning"),!1;if(y.value.isChildOf(c.id,E.id)||y.value.isChildOf(E.id,c.id))return U(l("project.wbsEditor.circular",{text:E.text}),"warning"),!1}return!0},b=async()=>{var c,d,E;const n=await _.value.getTaskResource();if(e.fineTuning){if(n===void 0||((c=n==null?void 0:n.resource)==null?void 0:c.length)===0)return U(l("project.wbsEditor.mustSelectHR")),!1;if(((d=n==null?void 0:n.resource)==null?void 0:d.length)>0){let P=!1;if(n.resource.forEach(M=>{M.resourceType===le.humanResource&&(P=!0)}),!P)return U(l("project.wbsEditor.mustSelectHR")),!1}}if(n){if((E=n==null?void 0:n.resource)!=null&&E.length){let P,M;for(let F=0;F<n.resource.length;F++){const N=n.resource[F];delete N._id,N.resourceType===le.humanResource&&(P||(P=N),N.isMainResource&&(M=!0))}!M&&P&&(P.isMainResource=!0)}n.task_resource=$e(n.resource,g.resourceOptions)}return n},h=()=>{_.value.validate().then(async n=>{var D;let c=T(n);const d=await f(),E=await b(),{add:P=[],update:M=[]}=d||{},F=a([...P,...M],c);if(E===!1||F===!1)return;c={...c,...E,predecessorData:d};const N=(D=y.value)==null?void 0:D.getTask(c.parent),C=[];N&&N.$target&&N.$target.length>0&&N.$target.forEach(m=>{var x;const w=(x=y.value)==null?void 0:x.getLink(m);w&&w.type!=="FS"&&w.type!=="SS"&&C.push(m)}),C.length>0?Bt({class:"wbs-confirm-modal wbs-delete-modal",title:l("project.wbsEditor.parentTaskLinkError",{text:N.text}),content:l("project.wbsEditor.parentTaskLinkErrorTip"),onOk:()=>{C.forEach(m=>{var w;(w=y.value)==null||w.deleteLink(m)}),t("sureAddOrUpdate",c),setTimeout(()=>{u.value=!1},15)}}):(t("sureAddOrUpdate",c),setTimeout(()=>{u.value=!1},15))})},r=()=>{i.action==="Add"&&t("cancelAddTask",i.id),setTimeout(()=>{u.value=!1},15)};return s({showTask:k}),()=>p(fe,{id:"addOrUpdateTaskModal",title:i.action==="Add"?l("project.wbsEditor.task.addTask"):l("project.wbsEditor.task.editTask"),closable:!0,isDrag:!0,centered:!0,width:886,visible:u.value,wrapClassName:"wbs-task-addUpdate-modal",destroyOnClose:!0,maskClosable:!1,okText:l("project.wbsEditor.confirm"),cancelText:l("project.wbsEditor.cancel"),onOk:h,onCancel:r},{default:()=>[p(mr,{ref:_,originTask:i.origin,action:i.action,fineTuning:e.fineTuning,durationUnit:e.durationUnit,durationFormatterObj:e.durationFormatterObj,scheduleProjectConstraint:e.scheduleProjectConstraint},null)]})}}),gr=Q({name:"ColumnConfig",emits:["setColumnConfig"],setup(e,{emit:t,expose:s}){const{t:l}=X(),i=A(!1),u=A([]),y=k=>{u.value=k.reduce((T,f)=>(f.name!=="custom_add"&&T.push({...f,show:!f.hide}),T),[]),i.value=!0},_=()=>{const k={};if(u.value.forEach(a=>{k[a.name]=!a.show}),!u.value.filter(a=>a.show).length){U(l("project.wbsEditor.cannotHiddeAll"));return}const f=u.value.map(a=>({...a,hide:a.show},{hide:!a.show,name:a.name,width:a.width,resize:a.resize,label:a.label,align:a.align,min_width:a.min_width,tree:a.tree}));t("setColumnConfig",f),i.value=!1},g=()=>{i.value=!1};return s({show:y}),()=>p(fe,{id:"columnConfigModal",title:l("project.wbsEditor.showColumns"),closable:!0,centered:!0,isDrag:!0,width:760,visible:i.value,destroyOnClose:!0,wrapClassName:"wbs-column-config-modal",okText:l("project.wbsEditor.confirm"),cancelText:l("project.wbsEditor.cancel"),onOk:_,onCancel:g},{default:()=>{var k;return[p("div",{class:"column-config-content"},[((k=u.value)==null?void 0:k.length)>0&&u.value.map((T,f)=>p("div",{class:"column-checkbox-container",key:f},[p(xe,{checked:T.show,"onUpdate:checked":a=>T.show=a},{default:()=>[p("span",{class:"column-checkbox-container-span"},[T.label_back??T.label])]})]))])]}})}}),br=Q({name:"ProjectDate",props:{durationUnit:{type:String,default:"minute"}},emits:["setProjectStartDate"],setup(e,{emit:t,expose:s}){const{t:l}=X(),i=A(!1),u=A(te()),y=k=>{u.value=te(k),i.value=!0},_=()=>document.body,g=()=>{t("setProjectStartDate",u.value),i.value=!1};return s({show:y}),()=>p(fe,{id:"SetProjectScheduleModal",title:l("project.wbsEditor.setProjectStartTime"),closable:!0,centered:!0,isDrag:!0,width:368,destroyOnClose:!0,maskClosable:!1,visible:i.value,wrapClassName:"wbs-project-date-modal",onOk:g,onCancel:()=>{i.value=!1},okText:l("project.wbsEditor.confirm"),cancelText:l("project.wbsEditor.cancel")},{default:()=>[p(Se,{class:"project-start-date-container"},{default:()=>[p(W,{label:l("project.wbsEditor.projectStartTime")},{default:()=>[p(Ce,{class:"datePicker",value:u.value,"onUpdate:value":k=>u.value=k,getPopupContainer:_,"time-type":e.durationUnit==="day"?"start":"time"},null)]})]})]})}}),wr=Q({name:"UpdateResource",props:{resourceGroupOptions:{type:Array,default:()=>[]}},emits:["batchUpdateResource"],setup(e,{emit:t,expose:s}){const{t:l}=X(),i=A(!1),u=A([]),y=()=>{i.value=!0},_=(T,f)=>f.name.toLowerCase().indexOf(T.toLowerCase())>=0,g=()=>{i.value=!1,t("batchUpdateResource",u.value),u.value=[]},k=()=>{i.value=!1,u.value=[]};return s({show:y}),()=>p(fe,{id:"batchUpdateReourceModal",title:l("project.wbsEditor.batchUpdateReource"),isDrag:!0,closable:!0,centered:!0,visible:i.value,destroyOnClose:!0,maskClosable:!1,wrapClassName:"wbs-update-resource-modal",okText:l("project.wbsEditor.confirm"),cancelText:l("project.wbsEditor.cancel"),onOk:g,onCancel:k},{default:()=>[p(Se,null,{default:()=>[p(W,{label:l("project.wbsEditor.resourceLoad.resource")},{default:()=>[p(ge,{value:u.value,"onUpdate:value":T=>u.value=T,allowClear:!0,showSearch:!0,mode:"multiple",autoClearSearchValue:!1,maxTagCount:30,options:e.resourceGroupOptions,optionLabelProp:"name","field-names":{label:"name",value:"id"},"filter-option":_,placeholder:l("project.wbsEditor.resourceLoad.selectResourceTip")},null)]})]})]})}}),yr=[{text:"project.wbs.load.planNormalLoad",groupIndex:"plan",dataIndex:"standardLoad",bgColor:"#95D150",renderTypes:["bar","line"]},{text:"project.wbs.load.planOverLoad",groupIndex:"plan",dataIndex:"overLoad",bgColor:"#F8C23C",renderTypes:["bar"]},{text:"project.wbs.load.planReleaseLoad",groupIndex:"plan",dataIndex:"releaseLoad",bgColor:"#999999",renderTypes:["bar"]},{text:"project.wbs.load.realNormalLoad",groupIndex:"actual",dataIndex:"standardLoad",bgColor:"#4C9FE8",renderTypes:["bar","line"]},{text:"project.wbs.load.realOverLoad",groupIndex:"actual",dataIndex:"overLoad",bgColor:"#EE854B",renderTypes:["bar"]}],kr=[{id:"0001",width:112,dataIndex:"name",text:"project.wbs.columns.task_resource"}];function He(e){return typeof e=="function"||Object.prototype.toString.call(e)==="[object Object]"&&!Pe(e)}const vr=Q({name:"LoadTable",props:{projectId:{type:String,required:!0,default:""},resourceOptions:{type:Array,default:()=>[]},queryLoadApi:{type:Object,default:()=>({})}},setup(e,{expose:t}){const{t:s}=X(),l=[];yr.forEach(r=>{l.push({get text(){return s(r.text)},groupIndex:r.groupIndex,dataIndex:r.dataIndex,bgColor:r.bgColor,renderTypes:r.renderTypes})});const i=[];kr.forEach(r=>{r.text=s(r.text),i.push({id:r.id,width:r.width,dataIndex:r.dataIndex,get text(){return s(r.text)}})});const u=A(!1),y=A(!1),_=A(!1),g=A(!1),k=ae({title:[],rows:[],page:1,pageSize:10,total:0}),T=ae({projectIdList:e.projectId?[e.projectId]:[],tempTask:"1",resIds:[],startTime:void 0,endTime:void 0,date:void 0}),f=ae({resId:"",date:""}),a=async()=>{var n;const r={...T,hasNoAudit:_.value,hasTemp:y.value,showEmptyPlan:!0,page:k.page};if(!r.startTime&&!r.endTime&&(r.startTime=J().format("YYYY-MM-DD"),r.endTime=J().add(1,"month").format("YYYY-MM-DD")),g.value=!0,((n=Object.keys(e==null?void 0:e.queryLoadApi))==null?void 0:n.length)===0){g.value=!1;return}_e({...e.queryLoadApi}).then(c=>{c.code===200?(k.title=c.data.title,k.rows=c.data.rows,k.page=c.data.page,k.pageSize=c.data.pageSize,k.total=c.data.total):U(c.msg)}).catch(()=>{k.title=[],k.rows=[],k.page=1,k.pageSize=10,k.total=0}).finally(()=>{g.value=!1})},b=r=>{T.resIds=r,a()},h=r=>{f.resId=r.id,f.date=r.content.date;let[n,c]=[0,0];Object.keys(r.content.plan).forEach(d=>{n+=r.content.plan[d]}),Object.keys(r.content.actual).forEach(d=>{c+=r.content.actual[d]}),u.value=!(n===0&&c===0)};return t({queryResourceLoad:b}),()=>p("div",{class:"resource-load-box"},[p(hn,{spinning:g.value},{default:()=>[p(Rn,{data:k,"row-data-indexs":l,"custom-columns":i,onClickChartCell:h},{customQuery:()=>{let r,n,c;return p(he,null,[p(Se,{layout:"inline"},{default:()=>[p(W,{label:s("project.wbsEditor.resourceLoad.timeRange")},{default:()=>[p(gn,{value:T.date,"onUpdate:value":d=>T.date=d,format:"YYYY-MM-DD",style:{width:"230px"},onChange:([d,E])=>{T.startTime=d,T.endTime=E}},null)]}),p(W,{label:s("project.wbsEditor.resourceLoad.resource")},{default:()=>[p(ge,{style:{width:"210px"},options:e.resourceOptions,mode:"tags","max-tag-count":"responsive","field-names":{label:"name",value:"id"},optionLabelProp:"name",value:T.resIds,"onUpdate:value":d=>T.resIds=d,placeholder:s("project.wbsEditor.resourceLoad.selectResource")},null)]}),p(W,null,{default:()=>[p(pe,{type:"primary",onClick:a},He(r=s("project.wbsEditor.query"))?r:{default:()=>[r]})]})]}),p("div",{class:"right-check-content"},[p(xe,{checked:y.value,"onUpdate:checked":d=>y.value=d,onChange:a},He(n=s("project.wbs.load.hasTempLog"))?n:{default:()=>[n]}),p(xe,{style:{"margin-right":"20px"},checked:_.value,"onUpdate:checked":d=>_.value=d,onChange:a},He(c=s("project.wbs.load.hasNotApprovedLog"))?c:{default:()=>[c]})])])}})]})])}}),Tr=Q({name:"ResourceLoad",props:{resourceOptions:{type:Array,default:()=>[]},queryLoadApi:{type:Object,default:()=>({})}},setup(e,{expose:t}){const{t:s}=X(),l=oe(Rt),i=A(),u=A(!1);return t({showProjectResource:_=>{u.value=!0,_.length>0&&Lt(()=>{var g;(g=i.value)==null||g.queryResourceLoad(_)})}}),()=>p(fe,{id:"ResourceLoadModal",title:s("project.wbsEditor.resourceLoad.resourceLoad"),isDrag:!0,closable:!0,centered:!0,width:"1400px",visible:u.value,wrapClassName:"wbs-project-resouce-modal",destroyOnClose:!0,footer:null,onCancel:()=>{u.value=!1}},{default:()=>[p(vr,{ref:i,"project-id":l,"resource-options":e.resourceOptions},null)]})}}),_r=Q({name:"HBBaseGanttEditor",props:{...er},emits:["saveBaseGanttData"],setup(e,{emit:t,expose:s,attrs:l,slots:i}){var ct,ut,ft,pt;const{t:u,mergeLocaleMessage:y,locale:_}=X();y("en-US",Tn),y("zh-CN",_n),ke(Ve,_),ke(Mt,e.bizType),window.localStorage.setItem("separateProjectStart",e.separateProjectStart+"");const g="base_gantt_editor_"+new Date().getTime(),k=A(""),T=A([]),f=A(!0);let a={};const b=A(),h=A(),r=A(),n=A(),c=A(),d=A(),E=A(),P=A(),M=A(),F=A();let N=[];const C=A({}),D=ae({enter:"day",store:"minute",format:"day",hoursPerDay:8,labels:{day:{full:"",plural:"",short:""}}}),m=A(!1),w=A(),x=A(),R=wn(x);let L=[];const q=z(()=>{const o=new Set(e.menuConfig.excludes?e.menuConfig.excludes:[]);return e.fineTuning,Array.from(o)}),S=z(()=>{const o=new Set(e.menuConfig.disabled?e.menuConfig.disabled:[]);return e.fineTuning&&(o.add("MilestoneTask"),o.add("ProjectCalendar"),o.add("ProjectSchedule")),Array.from(o)}),I=o=>{f.value=o},Y=Et(()=>{const o=[];a.eachSelectedTask(j=>o.push(j)),T.value=o},100);(ct=e==null?void 0:e.calendarsApi)!=null&&ct.params&&Object.assign(e.calendarsApi.params,{...e.calendarsApi.params,projectId:e.projectId}),(ut=e==null?void 0:e.configApi)!=null&&ut.params&&Object.assign(e.configApi.params,{...e.configApi.params,projectId:e.projectId}),(ft=e==null?void 0:e.dataSourceApi)!=null&&ft.params&&Object.assign(e.dataSourceApi.params,{...e.dataSourceApi.params,projectId:e.projectId,fineTuning:e.fineTuning,bizType:e.bizType});const[K,ne,B]=yn({initialLoad:e.initialLoad,calendarsApi:e.calendarsApi,configApi:e.configApi,dataSourceApi:e.dataSourceApi,afterCalendarsRequest:o=>Xe(o),afterConfigRequest:o=>et(o),afterDataRequest:o=>tt(o)}),{checkTaskCanOperate:Je,checkTaskCanAddChild:Ft,checkCanOperateLinks:Qe,checkSelectedTaskCanOperate:Me}=ar(C,B,e,u),Xe=o=>{var j;return(o==null?void 0:o.length)>0&&(D.hoursPerDay=(j=o[0])==null?void 0:j.day_hour),o==null||o.forEach(v=>{N.push({calendarId:v.calendarId})}),o},et=o=>{N.forEach(v=>{var H;const O=(H=a==null?void 0:a.getCalendar)==null?void 0:H.call(a,v.calendarId);O&&(v.calendar=O)});const j=Qn(o,a,D,N,{activeSearchCell:Oa,tempDurationUnit:e.durationUnit,selectedIds:T,userLang:_,baseConfig:we,t:u,props:e,baseGanttMethods:B});return Jn(j,{selectedIds:T,tempDurationUnit:e.durationUnit,userLang:_,currentGanttInstance:a})},tt=o=>{var j;return L=[],(j=o==null?void 0:o.data)==null||j.forEach(v=>{e.checkMileStoneUpdate&&v.type==="milestone"&&L.push(ze(v)),(!(v!=null&&v.parent)||(v==null?void 0:v.parent)=="-1"||(v==null?void 0:v.parent)=="0")&&(v.isRoot=!0),be.includes(v==null?void 0:v.task_status)&&(v.readonly=!0)}),e.fineTuning&&(o==null||o.links.forEach(v=>{let[O,H]=[null,null];o==null||o.data.forEach(ee=>{ee.id===v.source&&(O=ee),ee.id===v.target&&(H=ee)}),(O!=null&&O.readonly||H!=null&&H.readonly)&&(v.readonly=!0)})),o},Ht=()=>{var o,j;if(((o=l==null?void 0:l.calendars)==null?void 0:o.length)>0&&(N=[],Xe(l.calendars)),((j=l==null?void 0:l.columns)==null?void 0:j.length)>0){const v=ze(l.columns);et(v),a.config.columns.forEach(O=>{O.name===yt.ADDNAME&&v.unshift(O),O.name===yt.CHECKBOXNAME&&v.unshift(O)}),a.config.columns=v}l!=null&&l.data&&Object.keys(l.data).length!==0&&tt(l.data)},{beforeSaveBaseGanttData:qt,saveDifferenceBaseGanttData:Re,afterSaveBaseGanttData:zt}=tr(a,B,L,e,t,u),$t=()=>{a.attachEvent("onTaskCreated",o=>{var O;const j=a.getTask(o.parent),v=Ft(j);return v&&(o.id=vn(e.bizType),o[ie]=!0,o.$new=!0,o.text=u("project.wbsEditor.newTask"),o.duration=D.hoursPerDay*60,o.type||(o.type="task"),j!=null&&j.calendar_id?o.calendar_id=j==null?void 0:j.calendar_id:N.length>0&&(o.calendar_id=(O=N[0])==null?void 0:O.calendarId)),v}),a.attachEvent("onBeforeLightbox",o=>(Vt(o),!1)),a.attachEvent("onBeforeTaskAdd",(o,j)=>(!Sn(j.auto_scheduling)&&(j.auto_scheduling=!0),!0)),a.attachEvent("onTaskSelected",Y),a.attachEvent("onTaskUnselected",Y)},Vt=o=>{var v;const j=a.getTask(o);Je(j)&&(a.ext.tooltips.tooltip.hide(),ot(),(v=b.value)==null||v.showTask(j))},Gt=()=>{var j;const o=a.getSelectedTasks();if(o.length!==1)U(u("project.wbsEditor.selectSingleTip"));else{const v=a.getTask(o[0]);Je(v)&&((j=b.value)==null||j.showTask(v))}},Wt=o=>{if(o.$new){if(o.task_status=e.fineTuning?re.TASKWAITSTART:re.TASKNEW,e.fineTuning){let j=!1,v=o.parent;for(;a.isTaskExists(v);){const O=a.getTask(v);if((O==null?void 0:O.task_status)===re.TASKWAITRESOLVE){j=!0;break}v=O.parentId}j===!0&&(o.task_status=re.TASKNEW)}else{const j=a.getTaskBy(v=>v==null?void 0:v.isRoot);if(j.length>0&&j[0][De.AUTH_RESOLVE_FLAG]){const v=a.getTask(o.parent);((v==null?void 0:v.task_status)===re.TASKWAITSTART||(v==null?void 0:v.task_status)===re.TASKEXCUTE)&&(o.task_status=re.TASKWAITSTART)}}a.addTask(o,o.parent,a.getTaskIndex(o.id)),o.type==="task"&&(o.constraint_type==="asap"||o.constraint_type==="alap")&&a.autoSchedule(o.id),a.eachSelectedTask(j=>{a.isTaskExists(j)&&a.toggleTaskSelection(j)}),a.selectTask(o.id)}else a.updateTask(o.id,o);a.batchUpdate(()=>{var j,v,O,H,ee,mt;(v=(j=o==null?void 0:o.predecessorData)==null?void 0:j.delete)==null||v.forEach(V=>{a.deleteLink(V)}),(H=(O=o==null?void 0:o.predecessorData)==null?void 0:O.add)==null||H.forEach(V=>{V.lag!==void 0&&(V.lag=V.lag*D.hoursPerDay*60),a.addLink(V)}),(mt=(ee=o==null?void 0:o.predecessorData)==null?void 0:ee.update)==null||mt.forEach(V=>{a.getLink(V.id).type=V.type,a.getLink(V.id).source=V.source,V.lag!==void 0&&(a.getLink(V.id).lag=V.lag*D.hoursPerDay*60),a.updateLink(V.id)}),a.refreshTask(o.id)})},Kt=o=>a.deleteTask(o),Zt=()=>{const o=a.getSelectedTasks();if((o==null?void 0:o.length)!==1)return U(u("project.wbsEditor.selectSingleTaskTip"));const j=o[0];if(a.getTask(j).isRoot)return U(u("project.wbsEditor.cannotInsertBeforeRoot"));const v=a.getTaskIndex(j),O=a.getParent(j);a.createTask({text:u("project.wbsEditor.newTask")},O,v)},Jt=o=>{const j=a.getSelectedTasks();if((j==null?void 0:j.length)!==1)return U(u("project.wbsEditor.selectSingleTaskTip"));const v=j[0];a.createTask({text:u("project.wbsEditor.newTask"),...o},v)},Qt=()=>{},Xt=()=>{},ea=()=>{var H;const o=a.getSelectedTasks();if((o==null?void 0:o.length)!==1)return U(u("project.wbsEditor.selectSingleTaskTip"));const j=o[0];if(a.getTask(j).isRoot)return U(u("project.wbsEditor.cannotInsertBeforeRoot"));const v=a.getTaskIndex(j),O=a.getParent(j);(H=c.value)==null||H.show({parentId:O,taskIndex:v})},ta=o=>{const j=o.handleParams;let v=o.handleMethod;typeof v=="string"&&typeof Le[v]=="function"&&(v=Le[v]),typeof v=="function"&&(j?v(...j):v())},aa=(o,j)=>!o[ie]&&be.includes(o.task_status)?j.filter(v=>v.fineTuning!==!1):j.filter(v=>{var O;return((O=v==null?void 0:v.children)==null?void 0:O.length)>0&&(v.children=v.children.filter(H=>H.fineTuning!==!1)),v}),at=()=>{_.value;const o=new Set(e.contextMenuConfig.excludes);e.fineTuning&&o.add("MilestoneTask");const j={mode:"vertical",items:Nt(Un.map(v=>{let O;return v.children&&(O=v.children.map(H=>({...H,title:H.locale?u(H.locale):H.title}))),{...v,title:v.locale?u(v.locale):v.title,children:O}}),rt.value,{excludes:Array.from(o)}),menuItemClick:ta,menuItemClassName:"wbs-context-menu-item wbs-context-menu-item-vertical",subMenuClassName:"wbs-context-submenu-item wbs-context-submenu-item-vertical"};B.setBaseGanttContextMenu(j,aa)},Oe=A([]),na=()=>{_e({...e.menusApi}).then(o=>{o.code===200?(Oe.value=o.data.items,vt(at)):U(u("project.wbsEditor.queryFailTip"),"error")})};Object.keys(e.menusApi).length>0?na():(Oe.value=((pt=e.menusArray)==null?void 0:pt.length)>0?e.menusArray:[],vt(at));const nt=({buttons:o,names:j},v)=>{v.forEach(O=>{o.push(O),j.push(O.name),O.items&&nt({buttons:o,names:j},O.items)})},rt=z(()=>{const o=[],j=[];return nt({buttons:o,names:j},Oe.value),{buttons:o,names:j}}),ra=()=>{B.taskIndentAndOutdent("outdent")},oa=()=>{B.taskIndentAndOutdent("indent")},sa=()=>{const o=[];if(a.eachSelectedTask(j=>o.push(j)),o.length<=1)return U(u("project.wbsEditor.selectTwoMinTip"));Qe()&&B.addRelationTaskLink(o)},la=()=>{const o=[];if(a.eachSelectedTask(j=>o.push(j)),o.length<=1)return U(u("project.wbsEditor.selectTwoMinTip"));Qe()&&B.deleteRelationTaskLink(o)},ia=()=>{let o=!1,j=[];if(a.eachSelectedTask(O=>{const H=a.getTask(O);H!=null&&H.isRoot&&(o=H.isRoot),j.push(H)}),j.length===0)return U(u("project.wbsEditor.selectDeleteDataTip"));if(o)return U(u("project.wbsEditor.deleteRootTip"));if(!Me())return;let v=!1;if(j.forEach(O=>{(O==null?void 0:O.progress)>0&&(O==null?void 0:O.task_status)!==re.TASKNEW&&(v=!0),a.eachTask(H=>{(H==null?void 0:H.progress)>0&&(H==null?void 0:H.task_status)!==re.TASKNEW&&(v=!0)},O.id)}),v)return U(u("project.wbsEditor.progressStatusDeleteTip"));if(j=j.filter(O=>!O.readonly),!j.length)return U(u("project.wbsEditor.cannotDeleteTip"));Bt({class:"wbs-confirm-modal wbs-delete-modal",title:u("project.wbsEditor.deleteTask"),content:u("project.wbsEditor.confirmDeleteTip"),onOk:()=>new Promise((O,H)=>{setTimeout(()=>{B.deleteSelectedTask(j),O("")},220)})})},da=()=>{B.openProjectCalendar()},we=ae({resourceOptions:[],resource:{},resourceGroupOptions:[]}),ca=()=>{var o;(o=M.value)==null||o.show()},ua=()=>{var j;let o=[];a.eachSelectedTask(v=>{var H;const O=a.getTask(v);((H=O.resource)==null?void 0:H.length)>0&&O.resource.filter(ee=>ee.resourceType==="HR").forEach(ee=>{o.push(ee.resource)})}),o=[...new Set(o)],(j=F.value)==null||j.showProjectResource(o)},fa=()=>{w.value.show()},{updateResourceOptions:ot,batchUpdateResource:pa,checkCanRemoveResource:ma,addResourceData:ha,removeResourceData:ga}=rr(we,C,B,e,u),ba=o=>a.isWorkTime(o),wa=o=>a.getWorkHours(o),ya=()=>{if(e.separateProjectStart)n.value.show(a.config.project_start);else{const o=a.getChildren(a.config.root_id);if((o==null?void 0:o.length)>0){const j=a.getTask(o[0]);n.value.show(j.start_date)}}},ka=o=>{e.separateProjectStart?new Date(o).getTime()!==new Date(a.config.project_start).getTime()&&B.setBaseGanttProjectStart(o,!0):B.setBaseGanttProjectStart(o,!0)},va=o=>{o?B.hideBaseGanttChart():B.showBaseGanttChartGrid()},Ta=o=>{B.setBaseGanttZoom(o)},_a=()=>{B.switchBaseGanttBaseLine()},ja=o=>{B.expandBaseGanttLevel(o)},Ea=()=>{B.collapseBaseGanttLevel(0)},Ca=()=>{a.undo()},xa=()=>{a.redo()},Sa=()=>{B.copyOrCutBaseGanttData("copy")},Da=()=>{Me()&&B.copyOrCutBaseGanttData("cut")},Pa=()=>{Me(!1)&&B.pasteBaseGanttData()},Ma=()=>{B.openBaseGanttAbout()},Ra=()=>{P.value.show()},{activeSearchCell:Oa,searchResultStatus:Aa,searchTaskCell:La,resetSearchCell:Ba,replaceSearchCell:Na,replaceAllSearchCell:Ya}=jn(C,B,u),Ua=()=>{d.value.openDrawer()},Ia=o=>{B.filterBaseGanttTask(o),a.resetLayout()},Fa=()=>{r.value.show(B.getBaseGanttColumns())},Ha=o=>{var j;B.setBaseGanttColumnsDisplay(o),st(),Object.keys(e.saveColumnsApi).length!==0&&((j=e==null?void 0:e.saveColumnsApi)!=null&&j.params&&Object.assign(e.saveColumnsApi.params,{tenantCode:localStorage.getItem("current_tanent_id")??void 0,...e.saveColumnsApi.params,configData:o.map(v=>({dataIndex:v.name,width:v.width,show:!v.hide}))}),_e({...e.saveColumnsApi}).then(v=>{v.code===200?U(u("project.wbsEditor.columnSaveSuccess"),"success"):U(u("project.wbsEditor.columnSaveFail"))}))},qa=z(()=>B.getBaseGanttColumns()),za=()=>{E.value.openDrawer(qa.value)},$a=o=>{B.freezeBaseGanttColumns(o)},st=()=>{B.freezeBaseGanttColumns(-1)},Va=()=>{B.exportBaseGanttPNG()},Ga=()=>{B.exportBaseGanttPDF()},Wa=()=>{B.exportBaseGanttExcel()},Ka=()=>{B.exportBaseGanttMSProject()},Za=()=>{B.showBaseGanttChartGrid(),B.toggleCriticalPath(!0)},Ja=()=>{B.showBaseGanttChartGrid(),B.toggleCriticalPath(!1)},lt=()=>{a.ext.inlineEditors.save(),a.ext.inlineEditors.hide()},Qa=()=>B.checkDifferenceData(),Xa=()=>{e.editorMode==="local"&&(window.sessionStorage.setItem(Ue+"_"+e.bizType,e.editorMode+"_"+e.projectId),window.addEventListener("beforeunload",()=>{window.sessionStorage.setItem(Ue+"_"+e.bizType,"")}))},it=o=>{m.value=o===void 0?!m.value:o,Lt(()=>{a.render()})},Ae={switchGanttGrid:va,taskIndent:oa,taskOutdent:ra,deleteSelectData:ia,undo:Ca,redo:xa,expandAll:ja,collapseAll:Ea,highLightCriticalPath:Za,noLightCriticalPath:Ja,setCurrentZoom:Ta,addRelationTaskLink:sa,deleteRelationTaskLink:la,openColumnConfigModal:Fa,openSearch:Ra,copy:Sa,cut:Da,paste:Pa,insertTask:Zt,insertChildTask:Jt,insertValveTask:Qt,insertStageTask:Xt,insertRecurringTask:ea,toEditTask:Gt,about:Ma,handleProjectCalendar:da,openProjectScheduleModal:ya,openFilterDrawer:Ua,openFreezeColumns:za,cancelFreezeColumns:st,exportPNG:Va,exportPDF:Ga,exportExcel:Wa,exportMSProject:Ka,openProjectTeam:ca,openResourceLoad:ua,openUpdateResource:fa,switchBaseLine:_a,saveDifferenceBaseGanttData:Re},Le={save:Re,...Ae};s({getCureentGanttInstance:B.getBaseGanttInstance,closeBaseGanttLoading:B.closeBaseGanttLoading,enableBaseGanttLoading:B.enableBaseGanttLoading,checkDifferenceData:Qa,getDifferenceData:B.getDifferenceData,beforeSaveBaseGanttData:qt,afterSaveBaseGanttData:zt,...Ae,switchFullScreen:it,checkCanRemoveResource:ma,addResourceData:ha,removeResourceData:ga,getAllMethods:()=>B});const{handleKeyDown:dt}=nr(Ae,K,d,E,u),en=z(()=>({...ne,...l,data:Object.keys(e.dataSourceApi).length>0?ne.data:l.data,calendars:Object.keys(e.calendarsApi).length>0?ne.calendars:l.calendars,columns:Object.keys(e.configApi).length>0?ne.columns:l.columns}));return ke(Ee,C),ke(Rt,e.projectId),ke(Ge,we),Ot(()=>{var o,j;C.value=a=B.getBaseGanttInstance(),Ht(),$t(),k.value=B.getBaseGanttId(),ot(),Xa(),(j=(o=document.getElementById(g))==null?void 0:o.addEventListener)==null||j.call(o,"keydown",dt)}),Mn(()=>{a.refreshData()}),At(()=>{var o,j;e.editorMode==="local"&&window.sessionStorage.setItem(Ue+"_"+e.bizType,""),(j=(o=document.getElementById(g))==null?void 0:o.removeEventListener)==null||j.call(o,"keydown",dt)}),()=>{var o;return p("div",{id:g,tabindex:1,ref:h,class:["base-gantt-editor",m.value&&"editor-full-screen"]},[p("div",{class:"base-gantt-menus"},[e.enableGanttMenus&&(i!=null&&i.ganttMenus)?p("div",{class:"base-gantt-menus-container-slot",onMousedown:lt},[i.ganttMenus()]):p(or,{ganttId:k.value,allButtons:rt.value,handleMethods:Le,custom:e.menuConfig.custom,independent:e.menuConfig.independent,excludes:q.value,disables:S.value,onMousedown:lt},null),f.value&&p("div",{class:"base-gantt-menus-mask"},null)]),e.showFullScreen&&p("div",{class:"full-icon",style:{position:m.value?"fixed":"absolute",zIndex:m.value?2e3:10,marginTop:m.value?"-30px":"0"},onClick:()=>{it()}},[p(je,{name:m.value?"hoteam-exit-full-screen":"hoteam-full-screen",size:"20"},null)]),p("div",{class:"base-gantt-content",ref:x},[p(kn,Ke({ref:K},en.value,{durationUnit:e.durationUnit,fineTuning:e.fineTuning,bizType:e.bizType,enableFilter:!0,toolbar:!0,limitZoomInLevel:1,dragProgress:e.dragProgress,progressCalculate:e.progressCalculate,statusCalculate:!0,rowHeight:33,autoOpenLevel:!0,queryKeepLevel:!0,columnsLocale:!0,orderBranch:!0,gridElasticColumns:!1,highlightDragPosition:!0,dynamicTextPosition:!0,showStartEndDateLine:e.showStartEndDateLine,showProjectEndMarker:e.showProjectEndMarker,separateProjectStart:e.separateProjectStart,scheduleProjectConstraint:e.scheduleProjectConstraint,onSwitchMenuMask:I,onAutoSaveBaseGanttData:()=>{Re(!1)}}),null),p(hr,{ref:b,fineTuning:e.fineTuning,durationUnit:e.durationUnit,durationFormatterObj:D,scheduleProjectConstraint:e.scheduleProjectConstraint,onSureAddOrUpdate:Wt,onCancelAddTask:Kt},null),p(gr,{ref:r,onSetColumnConfig:Ha},null),p(br,{ref:n,isWorkTime:ba,getWorkHours:wa,durationUnit:e.durationUnit,onSetProjectStartDate:ka},null),p(En,{ref:d,durationFormatterObj:D,onFilter:Ia},null),p(Cn,{ref:E,ganttHeightWidth:R,onFreezeColumn:$a},null),p(xn,{ref:P,columns:(o=a==null?void 0:a.config)==null?void 0:o.columns,searchResultStatus:Aa,onSearchTaskCell:La,onResetSearchCell:Ba,onReplaceSearchCell:Na,onReplaceAllSearchCell:Ya},null),p(wr,{ref:w,resourceGroupOptions:we.resourceGroupOptions,onBatchUpdateResource:pa},null),p(Tr,{ref:F,queryLoadApi:e.queryLoadApi,resourceOptions:we.resourceOptions},null)])])}}});let Te=null;const jt=()=>{setTimeout(()=>{Te.destroy(),Te=null},20)},Dr=(e,t={},s={})=>{if(Te)return;const l=A(),i={title:`WBS编辑器 (${t.fineTuning?"微调计划":"编辑计划"})`,content:()=>p(_r,{...t,ref:l}),destroyOnClose:!0,isFull:!0,appContext:e,footer:null,wrapClassName:"bass-gantt-editor-modal-wrap",...s,noOkCancel:!0,keyboard:!1,onCancel(){var y,_;let u;s.onCancel&&(u=s.onCancel(l)),u!==!1&&((_=(y=l.value)==null?void 0:y.baseGanttMethods)!=null&&_.checkDifferenceData()?In({title:"提示",content:"当前有未保存的数据，是否确认关闭？",onOk:()=>{kt.emit("closeBaseGanttEditor",t.projectId),jt()}}):(kt.emit("closeBaseGanttEditor",t.projectId),jt()))}};return Te=fe.page(i),Te};export{_r as B,Ce as W,Dr as o};
